APS = subset_taxa(physeq.prune.rarefy, Class == i)
APS.plot = plot_richness(APS, x="Layer", color =("Layer"), measures=c("Observed")) + geom_boxplot(lwd=0.5) + ggtitle(i) + stat_compare_means(method = "t.test") + theme(plot.title = element_text(hjust = 0.5)) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
print(APS.plot)
}
pdf("./Figures/Bacterial_Phylum_Alpha_(Observed)_Diversity_by_Layer.pdf", width = 6, height = 3.8)
for (i in FungiClass.all) {
APS = subset_taxa(physeq.prune.rarefy, Class == i)
APS.plot = plot_richness(APS, x="Layer", color =("Layer"), measures=c("Observed")) + geom_boxplot(lwd=0.5) + ggtitle(i) + stat_compare_means(method = "t.test") + theme(plot.title = element_text(hjust = 0.5)) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
print(APS.plot)
}
dev.off()
pdf("./Figures/Bacterial_Phylum_Alpha_(Observed)_Diversity_by_Crust_type_surface_only.pdf", width = 6, height = 3.8 )
for (i in FungiClass) {
APS = subset_taxa(physeq.prune.rarefy.SF, Class == i)
APS.plot = plot_richness(APS, x="Crust_type", color =("Crust_type"), measures=c("Observed")) + geom_boxplot(lwd=0.5) + ggtitle(i) + stat_compare_means(method = "anova") + theme(plot.title = element_text(hjust = 0.5)) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
print(APS.plot)
}
dev.off()
knitr::opts_chunk$set(echo = TRUE)
library(ape)
library(vegan)
library(dplyr)
library(scales)
library(grid)
library(reshape2)
library(phyloseq)
library(magrittr)
library(ggplot2)
library(ggpubr)
library(plyr)
library(data.table)
library(tidyr)
library(tidyverse)
library(multcompView)
fast_melt = function(physeq){
# supports "naked" otu_table as `physeq` input.
otutab = as(otu_table(physeq), "matrix")
if(!taxa_are_rows(physeq)){otutab <- t(otutab)}
otudt = data.table(otutab, keep.rownames = TRUE)
setnames(otudt, "rn", "taxaID")
# Enforce character taxaID key
otudt[, taxaIDchar := as.character(taxaID)]
otudt[, taxaID := NULL]
setnames(otudt, "taxaIDchar", "taxaID")
# Melt count table
mdt = melt.data.table(otudt,
id.vars = "taxaID",
variable.name = "SampleID",
value.name = "count")
# Remove zeroes, NAs
mdt <- mdt[count > 0][!is.na(count)]
# Calculate relative abundance
mdt[, RelativeAbundance := count / sum(count), by = SampleID]
if(!is.null(tax_table(physeq, errorIfNULL = FALSE))){
# If there is a tax_table, join with it. Otherwise, skip this join.
taxdt = data.table(as(tax_table(physeq, errorIfNULL = TRUE), "matrix"), keep.rownames = TRUE)
setnames(taxdt, "rn", "taxaID")
# Enforce character taxaID key
taxdt[, taxaIDchar := as.character(taxaID)]
taxdt[, taxaID := NULL]
setnames(taxdt, "taxaIDchar", "taxaID")
# Join with tax table
setkey(taxdt, "taxaID")
setkey(mdt, "taxaID")
mdt <- taxdt[mdt]
}
return(mdt)
}
summarize_taxa = function(physeq, Rank, GroupBy = NULL){
Rank <- Rank[1]
if(!Rank %in% rank_names(physeq)){
message("The argument to `Rank` was:\n", Rank,
"\nBut it was not found among taxonomic ranks:\n",
paste0(rank_names(physeq), collapse = ", "), "\n",
"Please check the list shown above and try again.")
}
if(!is.null(GroupBy)){
GroupBy <- GroupBy[1]
if(!GroupBy %in% sample_variables(physeq)){
message("The argument to `GroupBy` was:\n", GroupBy,
"\nBut it was not found among sample variables:\n",
paste0(sample_variables(physeq), collapse = ", "), "\n",
"Please check the list shown above and try again.")
}
}
# Start with fast melt
mdt = fast_melt(physeq)
if(!is.null(GroupBy)){
# Add the variable indicated in `GroupBy`, if provided.
sdt = data.table(SampleID = sample_names(physeq),
var1 = get_variable(physeq, GroupBy))
setnames(sdt, "var1", GroupBy)
# Join
setkey(sdt, SampleID)
setkey(mdt, SampleID)
mdt <- sdt[mdt]
}
# Summarize
Nsamples = nsamples(physeq)
summarydt = mdt[, list(meanRA = sum(RelativeAbundance)/Nsamples,
sdRA = sd(RelativeAbundance),
minRA = min(RelativeAbundance),
maxRA = max(RelativeAbundance)),
by = c(Rank, GroupBy)]
return(summarydt)
}
plot_taxa_summary = function(physeq, Rank, GroupBy = NULL){
# Get taxa summary table
dt1 = summarize_taxa(physeq, Rank = Rank, GroupBy = GroupBy)
# Set factor appropriately for plotting
RankCol = which(colnames(dt1) == Rank)
setorder(dt1, -meanRA)
dt1[, RankFac := factor(dt1[[Rank]],
levels = rev(dt1[[Rank]]))]
dt1[, ebarMax := max(c(0, min(meanRA + sdRA))), by = eval(Rank)]
dt1[, ebarMin := max(c(0, min(meanRA - sdRA))), by = eval(Rank)]
# Set zeroes to one-tenth the smallest value
ebarMinFloor = dt1[(ebarMin > 0), min(ebarMin)]
ebarMinFloor <- ebarMinFloor / 10
dt1[(ebarMin == 0), ebarMin := ebarMinFloor]
pRank = ggplot(dt1, aes(x = meanRA, y = RankFac)) +
scale_x_log10() +
xlab("Mean Relative Abundance") +
ylab(Rank) +
theme_bw()
if(!is.null(GroupBy)){
# pRank <- pRank + facet_wrap(facets = as.formula(paste("~", GroupBy)))
pRank <- pRank + geom_point(mapping = aes_string(colour = GroupBy),
size = 5)
} else {
# Don't include error bars for faceted version
pRank <- pRank + geom_errorbarh(aes(xmax = ebarMax,
xmin = ebarMin))
}
return(pRank)
}
meta = read.table("Mojave_mappingfile_8-Aug-2018.txt",header=TRUE,row.names=1,sep="\t",stringsAsFactors=FALSE)
head(meta)
sampleData <- sample_data(meta)
otus <- read.table("MC2018FC.otu_table.txt",header=T,sep="\t",row.names=1)
otumat <- as(as.matrix(otus), "matrix")
OTU = otu_table(otumat, taxa_are_rows = TRUE)
head(OTU)
taxmat <- read.table("MC2018FC.taxonomy.fix.txt", header=T,sep="\t",row.names=1)
taxmat <- as(as.matrix(taxmat),"matrix")
TAX = tax_table(taxmat)
treefile = "MC2018FC.tree.phy"
tree = read.tree(treefile)
physeq = phyloseq(OTU,TAX,sampleData,tree)
physeq
physeq.prune = prune_taxa(taxa_sums(physeq) > 1, physeq)
physeq.prune
readcount = data.table(as(sample_data(physeq.prune), "data.frame"),
TotalReads = sample_sums(physeq.prune),
keep.rownames = TRUE)
setnames(readcount, "rn", "SampleID")
#For plotting, use command below.
#SeqDepth = ggplot(readcount, aes(TotalReads)) + geom_histogram() + ggtitle("Sequencing Depth")
readcount = readcount[order(readcount$TotalReads), c("SampleID", "TotalReads")]
head(readcount)
set.seed(1)
physeq.prune.rarefy = rarefy_even_depth(physeq.prune, sample.size = 6842, replace = FALSE, trimOTUs = FALSE)
physeq.prune.rarefy
physeq.prune.rarefy.SF = subset_samples(physeq.prune.rarefy, Layer=="Surface")
taxcom_layer = ggplot(data = psmelt(physeq.prune.rarefy.SF), mapping = aes_string(x = "Layer" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Layer")+
theme(axis.text.x = element_text(angle = 90, hjust = 1))
print(taxcom_layer)
taxcom_layer = ggplot(data = psmelt(physeq.prune.rarefy.SF), mapping = aes_string(x = "Layer" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Layer")+
theme(axis.text.x = element_text(angle = 90, hjust = 1))
print(taxcom_layer)
taxcom_layer = ggplot(data = psmelt(physeq.prune.rarefy), mapping = aes_string(x = "Layer" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Layer")+
theme(axis.text.x = element_text(angle = 90, hjust = 1))
print(taxcom_layer)
taxcom_layer = ggplot(data = psmelt(physeq.prune.rarefy), mapping = aes_string(x = "Layer" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Layer")+
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
theme_bw()
print(taxcom_layer)
pdf("./Figures/Fig3A_Fungal_Taxonomic_Composition_(Class_level)_by_Layer.pdf", width = 12, height = 8 )
taxcom_layer
dev.off()
pdf("./Figures/Fig3A_Fungal_Taxonomic_Composition_(Class_level)_by_Layer.pdf", width = 10, height = 6.8 )
taxcom_layer
dev.off()
pdf("./Figures/Fig3A_Fungal_Taxonomic_Composition_(Class_level)_by_Layer.pdf", width = 8, height = 5 )
taxcom_layer
dev.off()
pdf("./Figures/Fig3A_Fungal_Taxonomic_Composition_(Class_level)_by_Layer.pdf", width = 8, height = 5.8 )
taxcom_layer
dev.off()
plot_bar(physeq.prune.rarefy, x="Layer", fill = "Class")
tax_layer = plot_bar(physeq.prune.rarefy, x="Layer", fill = "Class") +
geom_bar(aes(color=Class, fill=Class), stat="identity", position="stack") +
theme_bw()
tax_layer
tax_layer
physeq.prune.rarefy
physeq.prune.rarefy = subset_taxa(physeq.prune.rarefy, Kingdom == "Fungi")
physeq.prune.rarefy
tax_layer = plot_bar(physeq.prune.rarefy, x="Layer", fill = "Class") +
geom_bar(aes(color=Class, fill=Class), stat="identity", position="stack") +
theme_bw()
tax_layer
taxcom_layer = ggplot(data = psmelt(physeq.prune.rarefy), mapping = aes_string(x = "Layer" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Layer")+
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
theme_bw()
print(taxcom_layer)
taxcom_site = ggplot(data = psmelt(physeq.prune.rarefy.SF), mapping = aes_string(x = "Site" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Site")+
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
theme_bw()
print(taxcom_site)
physeq.prune.rarefy.SF = subset_samples(physeq.prune.rarefy, Layer=="Surface")
tax_site = plot_bar(physeq.prune.rarefy.SF, x="Site", fill = "Class") +
geom_bar(aes(color=Class, fill=Class), stat="identity", position="stack") +
theme_bw()
tax_site
taxcom_layer = ggplot(data = psmelt(physeq.prune.rarefy), mapping = aes_string(x = "Layer" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Layer")+
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
theme_bw()
print(taxcom_layer)
ps.glom.class = tax_glom(physeq.prune.rarefy, taxrank = "Class")
taxcom_layer = ggplot(data = psmelt(ps.glom.class), mapping = aes_string(x = "Layer" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Layer")+
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
theme_bw()
print(taxcom_layer)
tax_layer = plot_bar(ps.glom.class, x="Layer", fill = "Class") +
geom_bar(aes(color=Class, fill=Class), stat="identity", position="stack") +
theme_bw()
taxcom_layer = ggplot(data = psmelt(ps.glom.class), mapping = aes_string(x = "Layer" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Layer")+
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
theme_bw() +
scale_colour_brewer(palette="Set1")
print(taxcom_layer)
taxcom_layer = ggplot(data = psmelt(ps.glom.class), mapping = aes_string(x = "Layer" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Layer")+
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
theme_bw() +
scale_colour_brewer(palette="Set1")
print(taxcom_layer)
taxcom_layer = ggplot(data = psmelt(physeq.prune.rarefy), mapping = aes_string(x = "Layer" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Layer")+
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
theme_bw() +
scale_colour_brewer(palette="Set1")
print(taxcom_layer)
taxcom_layer = ggplot(data = psmelt(physeq.prune.rarefy), mapping = aes_string(x = "Layer" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Layer")+
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
print(taxcom_layer)
pdf("./Figures/Fig3A_Fungal_Taxonomic_Composition_(Class_level)_by_Layer.pdf", width = 8, height = 5.8 )
taxcom_layer
dev.off()
FungiClass.all = as.character(get_taxa_unique(physeq.prune.rarefy, "Class"))
FungiClass.all = FungiClass.all[complete.cases(FungiClass.all)]
FungiClass.all = as.character(get_taxa_unique(physeq.prune.rarefy, "Class"))
FungiClass.all = FungiClass.all[complete.cases(FungiClass.all)]
FungiClass.all
APS = subset_taxa(physeq.prune.rarefy, Class == Sordariomycetes)
APS = subset_taxa(physeq.prune.rarefy, Class == "Sordariomycetes")
APS.plot = plot_richness(APS, x="Layer", color =("Layer"), measures=c("Observed")) + geom_boxplot(lwd=0.5) + ggtitle(i) + stat_compare_means(method = "t.test") + theme(plot.title = element_text(hjust = 0.5)) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
APS = subset_taxa(physeq.prune.rarefy, Class == "Sordariomycetes")
APS.plot = plot_richness(APS, x="Layer", color =("Layer"), measures=c("Observed")) + geom_boxplot(lwd=0.5) + ggtitle("Sordariomycetes") + stat_compare_means(method = "t.test") + theme(plot.title = element_text(hjust = 0.5)) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
print(APS.plot)
APS = subset_taxa(physeq.prune.rarefy, Class == "Sordariomycetes")
APS.plot = plot_richness(APS, x="Layer", color =("Layer"), measures=c("Observed")) + geom_boxplot(lwd=0.5) + ggtitle("Sordariomycetes") + stat_compare_means(method = "t.test", label.x.npc = c("center")) + theme(plot.title = element_text(hjust = 0.5)) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
print(APS.plot)
APS = subset_taxa(physeq.prune.rarefy, Class == "Sordariomycetes")
APS.plot = plot_richness(APS, x="Layer", color =("Layer"), measures=c("Observed")) + geom_boxplot(lwd=0.5) + ggtitle("Sordariomycetes") + stat_compare_means(method = "t.test", label.x.npc = c("right")) + theme(plot.title = element_text(hjust = 0.5)) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
print(APS.plot)
pdf("./Figures/Bacterial_Phylum_Alpha_(Observed)_Diversity_by_Layer.pdf", width = 6, height = 3.8)
for (i in FungiClass.all) {
APS = subset_taxa(physeq.prune.rarefy, Class == i)
APS.plot = plot_richness(APS, x="Layer", color =("Layer"), measures=c("Observed")) + geom_boxplot(lwd=0.5) + ggtitle(i) + stat_compare_means(method = "t.test", label.x.npc = c("right")) + theme(plot.title = element_text(hjust = 0.5)) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
print(APS.plot)
}
dev.off()
taxcom_site = ggplot(data = psmelt(physeq.prune.rarefy.SF), mapping = aes_string(x = "Site" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Site")+
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
theme_bw()
print(taxcom_site)
taxcom_site = ggplot(data = psmelt(physeq.prune.rarefy.SF), mapping = aes_string(x = "Site" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Site")+
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
theme_bw()
print(taxcom_site)
taxcom_site = ggplot(data = psmelt(physeq.prune.rarefy.SF), mapping = aes_string(x = "Site" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
theme_bw()
print(taxcom_site)
alpha.diversity.Sordariomycetes = estimate_richness(APS, measures = c("Observed"))
data.anova.Sordariomycetes = cbind(sample_data(APS), alpha.diversity.Sordariomycetes)
t.test(Observed ~ Layer, data.anova.Sordariomycetes)
APS = subset_taxa(physeq.prune.rarefy, Class == "Sordariomycetes")
alpha.diversity.Sordariomycetes = estimate_richness(APS, measures = c("Observed"))
data.anova.Sordariomycetes = cbind(sample_data(APS), alpha.diversity.Sordariomycetes)
t.test(Observed ~ Layer, data.anova.Sordariomycetes)
APS = subset_taxa(physeq.prune.rarefy, Class == "Basidiobolomycetes")
alpha.diversity.Sordariomycetes = estimate_richness(APS, measures = c("Observed"))
data.anova.Sordariomycetes = cbind(sample_data(APS), alpha.diversity.Sordariomycetes)
t.test(Observed ~ Layer, data.anova.Sordariomycetes)
APS = subset_taxa(physeq.prune.rarefy, Class == "Schizosaccharomycetes")
alpha.diversity.Sordariomycetes = estimate_richness(APS, measures = c("Observed"))
data.anova.Sordariomycetes = cbind(sample_data(APS), alpha.diversity.Sordariomycetes)
t.test(Observed ~ Layer, data.anova.Sordariomycetes)
pdf("./Figures/FigS1A_Fungal_Taxonomic_Composition_(Class_level)_by_Site.pdf", width = 8, height = 5.8 )
taxcom_site
dev.off()
physeq.prune.rarefy.SF = subset_samples(physeq.prune.rarefy, Layer=="Surface")
FungiClass = as.character(get_taxa_unique(physeq.prune.rarefy.SF, "Class"))
FungiClass = FungiClass[complete.cases(FungiClass)]
pdf("./Figures/Fungal_Class_Alpha_(Observed)_Diversity_by_Site_surface_only.pdf", width = 6, height = 3.8)
for (i in FungiClass) {
APS = subset_taxa(physeq.prune.rarefy.SF, Class == i)
APS.plot = plot_richness(APS, x="Site", color =("Site"), measures=c("Observed")) + geom_boxplot(lwd=0.5) + ggtitle(i) + stat_compare_means(method = "anova") + theme(plot.title = element_text(hjust = 0.5)) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
print(APS.plot)
}
dev.off()
taxcom_crust_type = ggplot(data = psmelt(physeq.prune.rarefy.SF), mapping = aes_string(x = "Crust_type" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
theme_bw()
print(taxcom_crust_type)
taxcom_crust_type = ggplot(data = psmelt(physeq.prune.rarefy.SF), mapping = aes_string(x = "Crust_type" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
theme_bw()
print(taxcom_crust_type)
pdf("./Figures/FigS1A_Fungal_Taxonomic_Composition_(Class_level)_by_Crust_type.pdf", width = 8, height = 5.8 )
taxcom_crust_type
dev.off()
knitr::opts_chunk$set(echo = TRUE)
library(ape)
library(vegan)
library(dplyr)
library(scales)
library(grid)
library(reshape2)
library(phyloseq)
library(magrittr)
library(ggplot2)
library(ggpubr)
library(plyr)
library(data.table)
library(tidyr)
library(tidyverse)
library(multcompView)
fast_melt = function(physeq){
# supports "naked" otu_table as `physeq` input.
otutab = as(otu_table(physeq), "matrix")
if(!taxa_are_rows(physeq)){otutab <- t(otutab)}
otudt = data.table(otutab, keep.rownames = TRUE)
setnames(otudt, "rn", "taxaID")
# Enforce character taxaID key
otudt[, taxaIDchar := as.character(taxaID)]
otudt[, taxaID := NULL]
setnames(otudt, "taxaIDchar", "taxaID")
# Melt count table
mdt = melt.data.table(otudt,
id.vars = "taxaID",
variable.name = "SampleID",
value.name = "count")
# Remove zeroes, NAs
mdt <- mdt[count > 0][!is.na(count)]
# Calculate relative abundance
mdt[, RelativeAbundance := count / sum(count), by = SampleID]
if(!is.null(tax_table(physeq, errorIfNULL = FALSE))){
# If there is a tax_table, join with it. Otherwise, skip this join.
taxdt = data.table(as(tax_table(physeq, errorIfNULL = TRUE), "matrix"), keep.rownames = TRUE)
setnames(taxdt, "rn", "taxaID")
# Enforce character taxaID key
taxdt[, taxaIDchar := as.character(taxaID)]
taxdt[, taxaID := NULL]
setnames(taxdt, "taxaIDchar", "taxaID")
# Join with tax table
setkey(taxdt, "taxaID")
setkey(mdt, "taxaID")
mdt <- taxdt[mdt]
}
return(mdt)
}
summarize_taxa = function(physeq, Rank, GroupBy = NULL){
Rank <- Rank[1]
if(!Rank %in% rank_names(physeq)){
message("The argument to `Rank` was:\n", Rank,
"\nBut it was not found among taxonomic ranks:\n",
paste0(rank_names(physeq), collapse = ", "), "\n",
"Please check the list shown above and try again.")
}
if(!is.null(GroupBy)){
GroupBy <- GroupBy[1]
if(!GroupBy %in% sample_variables(physeq)){
message("The argument to `GroupBy` was:\n", GroupBy,
"\nBut it was not found among sample variables:\n",
paste0(sample_variables(physeq), collapse = ", "), "\n",
"Please check the list shown above and try again.")
}
}
# Start with fast melt
mdt = fast_melt(physeq)
if(!is.null(GroupBy)){
# Add the variable indicated in `GroupBy`, if provided.
sdt = data.table(SampleID = sample_names(physeq),
var1 = get_variable(physeq, GroupBy))
setnames(sdt, "var1", GroupBy)
# Join
setkey(sdt, SampleID)
setkey(mdt, SampleID)
mdt <- sdt[mdt]
}
# Summarize
Nsamples = nsamples(physeq)
summarydt = mdt[, list(meanRA = sum(RelativeAbundance)/Nsamples,
sdRA = sd(RelativeAbundance),
minRA = min(RelativeAbundance),
maxRA = max(RelativeAbundance)),
by = c(Rank, GroupBy)]
return(summarydt)
}
plot_taxa_summary = function(physeq, Rank, GroupBy = NULL){
# Get taxa summary table
dt1 = summarize_taxa(physeq, Rank = Rank, GroupBy = GroupBy)
# Set factor appropriately for plotting
RankCol = which(colnames(dt1) == Rank)
setorder(dt1, -meanRA)
dt1[, RankFac := factor(dt1[[Rank]],
levels = rev(dt1[[Rank]]))]
dt1[, ebarMax := max(c(0, min(meanRA + sdRA))), by = eval(Rank)]
dt1[, ebarMin := max(c(0, min(meanRA - sdRA))), by = eval(Rank)]
# Set zeroes to one-tenth the smallest value
ebarMinFloor = dt1[(ebarMin > 0), min(ebarMin)]
ebarMinFloor <- ebarMinFloor / 10
dt1[(ebarMin == 0), ebarMin := ebarMinFloor]
pRank = ggplot(dt1, aes(x = meanRA, y = RankFac)) +
scale_x_log10() +
xlab("Mean Relative Abundance") +
ylab(Rank) +
theme_bw()
if(!is.null(GroupBy)){
# pRank <- pRank + facet_wrap(facets = as.formula(paste("~", GroupBy)))
pRank <- pRank + geom_point(mapping = aes_string(colour = GroupBy),
size = 5)
} else {
# Don't include error bars for faceted version
pRank <- pRank + geom_errorbarh(aes(xmax = ebarMax,
xmin = ebarMin))
}
return(pRank)
}
meta = read.table("Mojave_mappingfile_8-Aug-2018.txt",header=TRUE,row.names=1,sep="\t",stringsAsFactors=FALSE)
head(meta)
sampleData <- sample_data(meta)
otus <- read.table("MC2018FC.otu_table.txt",header=T,sep="\t",row.names=1)
otumat <- as(as.matrix(otus), "matrix")
OTU = otu_table(otumat, taxa_are_rows = TRUE)
head(OTU)
taxmat <- read.table("MC2018FC.taxonomy.fix.txt", header=T,sep="\t",row.names=1)
taxmat <- as(as.matrix(taxmat),"matrix")
TAX = tax_table(taxmat)
treefile = "MC2018FC.tree.phy"
tree = read.tree(treefile)
physeq = phyloseq(OTU,TAX,sampleData,tree)
physeq
physeq.prune = prune_taxa(taxa_sums(physeq) > 1, physeq)
physeq.prune
readcount = data.table(as(sample_data(physeq.prune), "data.frame"),
TotalReads = sample_sums(physeq.prune),
keep.rownames = TRUE)
setnames(readcount, "rn", "SampleID")
#For plotting, use command below.
#SeqDepth = ggplot(readcount, aes(TotalReads)) + geom_histogram() + ggtitle("Sequencing Depth")
readcount = readcount[order(readcount$TotalReads), c("SampleID", "TotalReads")]
head(readcount)
set.seed(1)
physeq.prune.rarefy = rarefy_even_depth(physeq.prune, sample.size = 6842, replace = FALSE, trimOTUs = FALSE)
physeq.prune.rarefy
physeq.prune.rarefy
physeq.prune.rarefy = subset_taxa(physeq.prune.rarefy, Kingdom == "Fungi")
physeq.prune.rarefy
taxcom_layer = ggplot(data = psmelt(physeq.prune.rarefy), mapping = aes_string(x = "Layer" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Layer")+
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
print(taxcom_layer)
png("./Figures/Fig3A_Fungal_Taxonomic_Composition_(Class_level)_by_Layer.png", units="in", width = 8, height = 5.8, res = 300 )
taxcom_layer
dev.off()
