knitr::opts_chunk$set(echo = TRUE)
library(ape)
library(vegan)
library(plyr)
library(dplyr)
library(scales)
library(grid)
library(reshape2)
library(phyloseq)
library(magrittr)
library(ggplot2)
library(ggpubr)
library(data.table)
library(tidyr)
library(tidyverse)
getwd()
fast_melt = function(physeq){
# supports "naked" otu_table as `physeq` input.
otutab = as(otu_table(physeq), "matrix")
if(!taxa_are_rows(physeq)){otutab <- t(otutab)}
otudt = data.table(otutab, keep.rownames = TRUE)
setnames(otudt, "rn", "taxaID")
# Enforce character taxaID key
otudt[, taxaIDchar := as.character(taxaID)]
otudt[, taxaID := NULL]
setnames(otudt, "taxaIDchar", "taxaID")
# Melt count table
mdt = melt.data.table(otudt,
id.vars = "taxaID",
variable.name = "SampleID",
value.name = "count")
# Remove zeroes, NAs
mdt <- mdt[count > 0][!is.na(count)]
# Calculate relative abundance
mdt[, RelativeAbundance := count / sum(count), by = SampleID]
if(!is.null(tax_table(physeq, errorIfNULL = FALSE))){
# If there is a tax_table, join with it. Otherwise, skip this join.
taxdt = data.table(as(tax_table(physeq, errorIfNULL = TRUE), "matrix"), keep.rownames = TRUE)
setnames(taxdt, "rn", "taxaID")
# Enforce character taxaID key
taxdt[, taxaIDchar := as.character(taxaID)]
taxdt[, taxaID := NULL]
setnames(taxdt, "taxaIDchar", "taxaID")
# Join with tax table
setkey(taxdt, "taxaID")
setkey(mdt, "taxaID")
mdt <- taxdt[mdt]
}
return(mdt)
}
summarize_taxa = function(physeq, Rank, GroupBy = NULL){
Rank <- Rank[1]
if(!Rank %in% rank_names(physeq)){
message("The argument to `Rank` was:\n", Rank,
"\nBut it was not found among taxonomic ranks:\n",
paste0(rank_names(physeq), collapse = ", "), "\n",
"Please check the list shown above and try again.")
}
if(!is.null(GroupBy)){
GroupBy <- GroupBy[1]
if(!GroupBy %in% sample_variables(physeq)){
message("The argument to `GroupBy` was:\n", GroupBy,
"\nBut it was not found among sample variables:\n",
paste0(sample_variables(physeq), collapse = ", "), "\n",
"Please check the list shown above and try again.")
}
}
# Start with fast melt
mdt = fast_melt(physeq)
if(!is.null(GroupBy)){
# Add the variable indicated in `GroupBy`, if provided.
sdt = data.table(SampleID = sample_names(physeq),
var1 = get_variable(physeq, GroupBy))
setnames(sdt, "var1", GroupBy)
# Join
setkey(sdt, SampleID)
setkey(mdt, SampleID)
mdt <- sdt[mdt]
}
# Summarize
Nsamples = nsamples(physeq)
summarydt = mdt[, list(meanRA = sum(RelativeAbundance)/Nsamples,
sdRA = sd(RelativeAbundance),
minRA = min(RelativeAbundance),
maxRA = max(RelativeAbundance)),
by = c(Rank, GroupBy)]
return(summarydt)
}
plot_taxa_summary = function(physeq, Rank, GroupBy = NULL){
# Get taxa summary table
dt1 = summarize_taxa(physeq, Rank = Rank, GroupBy = GroupBy)
# Set factor appropriately for plotting
RankCol = which(colnames(dt1) == Rank)
setorder(dt1, -meanRA)
dt1[, RankFac := factor(dt1[[Rank]],
levels = rev(dt1[[Rank]]))]
dt1[, ebarMax := max(c(0, min(meanRA + sdRA))), by = eval(Rank)]
dt1[, ebarMin := max(c(0, min(meanRA - sdRA))), by = eval(Rank)]
# Set zeroes to one-tenth the smallest value
ebarMinFloor = dt1[(ebarMin > 0), min(ebarMin)]
ebarMinFloor <- ebarMinFloor / 10
dt1[(ebarMin == 0), ebarMin := ebarMinFloor]
pRank = ggplot(dt1, aes(x = meanRA, y = RankFac)) +
scale_x_log10() +
xlab("Mean Relative Abundance") +
ylab(Rank) +
theme_bw()
if(!is.null(GroupBy)){
# pRank <- pRank + facet_wrap(facets = as.formula(paste("~", GroupBy)))
pRank <- pRank + geom_point(mapping = aes_string(colour = GroupBy),
size = 5)
} else {
# Don't include error bars for faceted version
pRank <- pRank + geom_errorbarh(aes(xmax = ebarMax,
xmin = ebarMin))
}
return(pRank)
}
otu = read.table(file="MojaveBacQ2FWLEsilva515806.otu_table.fix.txt", header=T, sep='\t')
head(otu)
dim(otu)
tax <- read.table(file="taxonomy.fix.tsv", sep='\t', header=TRUE)
head(tax)
dim(tax)
tax_filtered <- tax[tax$OTU.ID %in% otu$OTU.ID,]
head(tax_filtered)
dim(tax_filtered)
dim(otu)
tax_filtered = tax_filtered[,c(1,2)]
tax_filtered = separate(tax_filtered, Taxon, c("Kingdom","Phylum","Class","Order", "Family", "Genus","Species"), sep= ";", remove=TRUE)
dim(tax_filtered)
head(tax_filtered)
write.csv(tax_filtered, file="taxonomy_phyloseq_fix.csv")
otus <- read.table("MojaveBacQ2FWLEsilva515806.otu_table.fix.txt",
header=T,sep="\t",row.names = 1)
otumat <- as(as.matrix(otus), "matrix")
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxmat <- read.csv("taxonomy_phyloseq_fix.csv",
sep=",",row.names=1)
row.names(taxmat) = taxmat$OTU.ID
taxmat <- as(as.matrix(taxmat),"matrix")
TAX = tax_table(taxmat)
treefile = "tree.nwk"
tree = read.tree(treefile)
meta = read.table("Mojave_mappingfile_8-Aug-2018.txt",
header=TRUE,row.names=1,
sep="\t",stringsAsFactors=FALSE)
meta <- meta[which(meta$Layer %in% c("Surface")),]
head(meta)
sampleData <- sample_data(meta)
physeq = phyloseq(OTU,TAX,sampleData,tree)
physeq
physeq
physeq.prune = prune_taxa(taxa_sums(physeq) > 5, physeq)
physeq.prune
meta = read.table("Mojave_mappingfile_8-Aug-2018.txt",
header=TRUE,row.names=1,
sep="\t",stringsAsFactors=FALSE)
#meta <- meta[which(meta$Layer %in% c("Surface")),]
head(meta)
sampleData <- sample_data(meta)
physeq = phyloseq(OTU,TAX,sampleData,tree)
physeq
physeq.prune = prune_taxa(taxa_sums(physeq) > 5, physeq)
physeq.prune
readcount = data.table(as(sample_data(physeq.prune), "data.frame"),
TotalReads = sample_sums(physeq.prune),
keep.rownames = TRUE)
setnames(readcount, "rn", "SampleID")
#For plotting, use command below.
#SeqDepth = ggplot(readcount, aes(TotalReads)) + geom_histogram() + ggtitle("Sequencing Depth")
readcount = readcount[order(readcount$TotalReads), c("SampleID", "TotalReads")]
head(readcount)
set.seed(711)
physeq.prune.rarefy = rarefy_even_depth(physeq.prune, sample.size = 37435, replace = FALSE, trimOTUs = TRUE)
physeq.prune.rarefy
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy, x="Crust_type", color=("Crust_type"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity (Observed) by Crust type") + stat_compare_means(method = "anova", label.y = 3000) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "LAC", label.y = 2800, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.plot.richness.Crust_type
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy, x="Crust_type", color=("Crust_type"), measures=c("Chao1")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity (Observed) by Crust type") + stat_compare_means(method = "anova", label.y = 3000) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "LAC", label.y = 2800, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.plot.richness.Crust_type
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy, x="Crust_type", color=("Crust_type"), measures=c("Shannon")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity (Observed) by Crust type") + stat_compare_means(method = "anova", label.y = 3000) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "LAC", label.y = 2800, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.plot.richness.Crust_type
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy, x="Crust_type", color=("Crust_type"), measures=c("Shannon")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity (Observed) by Crust type") + stat_compare_means(method = "anova", label.y = 10) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "LAC", label.y = 2800, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.plot.richness.Crust_type
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy, x="Crust_type", color=("Crust_type"), measures=c("Shannon")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity (Observed) by Crust type") + stat_compare_means(method = "anova", label.y = 10) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "LAC", label.y = 10, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.plot.richness.Crust_type
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy, x="Crust_type", color=("Crust_type"), measures=c("Shannon")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity (Observed) by Crust type") + stat_compare_means(method = "anova", label.y = 8) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "LAC", label.y = 8, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.plot.richness.Crust_type
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy, x="Crust_type", color=("Crust_type"), measures=c("Chao1")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity (Observed) by Crust type") + stat_compare_means(method = "anova", label.y = 3000) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "LAC", label.y = 2800, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.plot.richness.Crust_type
pdf("/Figures/Mojave Biocrust Bacterial Alpha (Chao1) Diversity by Crust type.pdf", width = 8, height = 5 )
pdf("./Figures/Mojave Biocrust Bacterial Alpha (Chao1) Diversity by Crust type.pdf", width = 8, height = 5 )
physeq.prune.rarefy.plot.richness.Crust_type
dev.off()
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy, x="Crust_type", color=("Crust_type"), measures=c("Chao1")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity (Chao1) by Crust type") + stat_compare_means(method = "anova", label.y = 3000) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "LAC", label.y = 2800, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.plot.richness.Crust_type
pdf("./Figures/Mojave Biocrust Bacterial Alpha (Chao1) Diversity by Crust type.pdf", width = 8, height = 5 )
physeq.prune.rarefy.plot.richness.Crust_type
dev.off()
physeq.prune.rarefy.plot.richness.Site_layer = plot_richness(physeq.prune.rarefy, x="Site_layer", color=("Site_layer"), measures=c("Chao1")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity (Observed) by Site and Layer") + stat_compare_means(method = "anova", label.y = 3000) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "JTNP_SF", label.y = 2800, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.plot.richness.Site_layer
physeq.prune.rarefy.plot.richness.Site_layer = plot_richness(physeq.prune.rarefy, x="Site_layer", color=("Site_layer"), measures=c("Chao1")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity (Chao1) by Site and Layer") + stat_compare_means(method = "anova", label.y = 3000) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "JTNP_SF", label.y = 2800, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.plot.richness.Site_layer
pdf("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/Mojave_Project/Mojave_16S_Qiime2/Figures/Mojave Biocrust Bacterial Alpha (Observed) Diversity by Site and Layer.pdf", width = 8, height = 5 )
physeq.prune.rarefy.plot.richness.Site_layer
dev.off()
pdf("./Figures/Mojave Biocrust Bacterial Alpha (Chao1) Diversity by Site and Layer.pdf", width = 8, height = 5 )
physeq.prune.rarefy.plot.richness.Site_layer
dev.off()
otu.rare <- otu_table(physeq.prune.rarefy)
otu.rare <- as.data.frame(t(otu.rare))
sample_names <- rownames(otu.rare)
#vegan rarecurve
otu.rarecurve <- rarecurve(otu.rare, step = 1000, sample = 37435, label = T)
rare <- lapply(otu.rarecurve, function(x){
b <- as.data.frame(x)
b <- data.frame(ASV = b[,1], Sample.size = rownames(b))
b$Sample.size <- as.numeric(gsub("N", "",  b$Sample.size))
return(b)
})
names(rare) <- sample_names
names(rare) <- sample_names
#tidyverse
rare <- map_dfr(rare, function(x){
z <- data.frame(x)
return(z)
}, .id = "sample")
head(rare)
ggplot(data = rare)+
geom_line(aes(x = Sample.size, y = ASV, color = sample), show.legend = FALSE)+
scale_x_continuous(labels =  waiver()) + theme_bw() + ggtitle("Bacterial Rarefaction Curve")+
theme(plot.title = element_text(hjust = 0.5))
pdf("./Figures/Bacterial Rarefaction Curve.pdf", width = 8, height = 5 )
ggplot(data = rare)+
geom_line(aes(x = Sample.size, y = ASV, color = sample), show.legend = FALSE)+
scale_x_continuous(labels =  waiver()) + theme_bw() + ggtitle("Bacterial Rarefaction Curve")+
theme(plot.title = element_text(hjust = 0.5))
dev.off()
taxcom_sitelayer = ggplot(data = psmelt(physeq.prune.rarefy), mapping = aes_string(x = "Site_layer" ,y = "Abundance", fill = "Phylum" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Bacterial Taxonomic Composition by Site and Layer")+
theme(axis.text.x = element_text(angle = 90, hjust = 1))+
theme(plot.title = element_text(hjust = 0.5))
#print(taxcom_sitelayer)
pdf("./Figures/Bacterial Taxonomic Composition by Site and Layer.pdf", width = 10, height = 6 )
taxcom_sitelayer
dev.off()
taxcom_crusttype = ggplot(data = psmelt(physeq.prune.rarefy), mapping = aes_string(x = "Crust_type" ,y = "Abundance", fill = "Phylum" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Bacterial Taxonomic Composition by Crust type")+
theme(axis.text.x = element_text(angle = 90, hjust = 1))+
theme(plot.title = element_text(hjust = 0.5))
#print(taxcom_crusttype)
pdf("./Figures/Bacterial Taxonomic Composition by Crust type.pdf", width = 10, height = 6 )
taxcom_crusttype
dev.off()
BacPhylum = as.character(get_taxa_unique(physeq.prune.rarefy, "Phylum"))
BacPhylum = BacPhylum[complete.cases(BacPhylum)]
pdf("./Figures/Bacterial Phylum Alpha (Chao1) Diversity by Site and Layer.pdf", width = 8, height = 5 )
for (i in BacPhylum) {
APS = subset_taxa(physeq.prune.rarefy, Phylum == i)
APS.plot = plot_richness(APS, x="Site_layer", color =("Site_layer"), measures=c("Chao1")) + geom_boxplot() + ggtitle(i) + stat_compare_means(method = "anova") + theme(plot.title = element_text(hjust = 0.5))
print(APS.plot)
}
dev.off()
str(BacPhylum)
pdf("./Figures/Bacterial Phylum Alpha (Chao1) Diversity by Crust_type .pdf", width = 8, height = 5 )
for (i in BacPhylum) {
APS = subset_taxa(physeq.prune.rarefy, Phylum == i)
APS.plot = plot_richness(APS, x="Crust_type", color =("Crust_type"), measures=c("Chao1")) + geom_boxplot() + ggtitle(i) + stat_compare_means(method = "anova") + theme(plot.title = element_text(hjust = 0.5))
print(APS.plot)
}
dev.off()
taxa.summary.by.phylum = summarize_taxa(physeq.prune.rarefy, "Phylum")
write.table(taxa.summary.by.phylum, file = "taxa.summary.by.phylum.txt", sep ="\t")
getwd()
setwd("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/BiocrustDiv/Fungi")
getwd()
knitr::opts_chunk$set(echo = TRUE)
library(ape)
library(vegan)
library(dplyr)
library(scales)
library(grid)
library(reshape2)
library(phyloseq)
library(magrittr)
library(ggplot2)
library(ggpubr)
library(plyr)
library(data.table)
library(tidyr)
library(tidyverse)
meta = read.table("Mojave_mappingfile_8-Aug-2018.txt",header=TRUE,row.names=1,sep="\t",stringsAsFactors=FALSE)
head(meta)
sampleData <- sample_data(meta)
otus <- read.table("MC2018FC.otu_table.txt",header=T,sep="\t",row.names=1)
otumat <- as(as.matrix(otus), "matrix")
OTU = otu_table(otumat, taxa_are_rows = TRUE)
head(OTU)
taxmat <- read.table("MC2018FC.taxonomy.fix.txt", header=T,sep="\t",row.names=1)
taxmat <- as(as.matrix(taxmat),"matrix")
TAX = tax_table(taxmat)
treefile = "MC2018FC.tree.phy"
tree = read.tree(treefile)
physeq = phyloseq(OTU,TAX,sampleData,tree)
physeq
physeq.prune = prune_taxa(taxa_sums(physeq) > 1, physeq)
physeq.prune
readcount = data.table(as(sample_data(physeq.prune), "data.frame"),
TotalReads = sample_sums(physeq.prune),
keep.rownames = TRUE)
setnames(readcount, "rn", "SampleID")
#For plotting, use command below.
#SeqDepth = ggplot(readcount, aes(TotalReads)) + geom_histogram() + ggtitle("Sequencing Depth")
readcount = readcount[order(readcount$TotalReads), c("SampleID", "TotalReads")]
head(readcount)
set.seed(1)
physeq.prune.rarefy = rarefy_even_depth(physeq.prune, sample.size = 6842, replace = FALSE, trimOTUs = FALSE)
physeq.prune.rarefy
otu.rare <- otu_table(physeq.prune.rarefy.ps)
otu.rare <- otu_table(physeq.prune.rarefy)
otu.rare <- as.data.frame(t(otu.rare))
sample_names <- rownames(otu.rare)
#vegan rarecurve
otu.rarecurve <- rarecurve(otu.rare, step = 500, sample = 30000, label = T)
rare <- lapply(otu.rarecurve, function(x){
b <- as.data.frame(x)
b <- data.frame(OTU = b[,1], Sample.size = rownames(b))
b$Sample.size <- as.numeric(gsub("N", "",  b$Sample.size))
return(b)
})
names(rare) <- sample_names
#tidyverse
rare <- map_dfr(rare, function(x){
z <- data.frame(x)
return(z)
}, .id = "sample")
head(rare)
head(rare)
ggplot(data = rare)+
geom_line(aes(x = Sample.size, y = OTU, color = sample), show.legend = FALSE)+
scale_x_continuous(labels =  waiver()) + theme_bw() + ggtitle("Fungal Rarefaction Curve")+
theme(plot.title = element_text(hjust = 0.5))
pdf("./Figures/Fungal Rarefaction Curve.pdf", width = 8, height = 5 )
ggplot(data = rare)+
geom_line(aes(x = Sample.size, y = OTU, color = sample), show.legend = FALSE)+
scale_x_continuous(labels =  waiver()) + theme_bw() + ggtitle("Fungal Rarefaction Curve")+
theme(plot.title = element_text(hjust = 0.5))
dev.off()
physeq.prune.rarefy.ps.plot.richness = plot_richness(physeq.prune.rarefy.ps, x="Crust_type", color=("Crust_type"), measures=c("Chao1")) + geom_boxplot() + ggtitle("Mojave Biocrust Fungal Alpha Diversity (Chao1) by Crust type") + stat_compare_means(method = "anova", label.y = 400) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = ".all.", label.y = 380, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.ps.plot.richness = plot_richness(physeq.prune.rarefy, x="Crust_type", color=("Crust_type"), measures=c("Chao1")) + geom_boxplot() + ggtitle("Mojave Biocrust Fungal Alpha Diversity (Chao1) by Crust type") + stat_compare_means(method = "anova", label.y = 400) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = ".all.", label.y = 380, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.ps.plot.richness
physeq.prune.rarefy.ps.plot.richness = plot_richness(physeq.prune.rarefy, x="Crust_type", color=("Crust_type"), measures=c("Chao1")) + geom_boxplot() + ggtitle("Mojave Biocrust Fungal Alpha Diversity (Chao1) by Crust type") + stat_compare_means(method = "anova", label.y = 400) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "LAC", label.y = 380, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.ps.plot.richness
physeq.prune.rarefy.ps.plot.richness = plot_richness(physeq.prune.rarefy, x="Crust_type", color=("Crust_type"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Fungal Alpha Diversity (Chao1) by Crust type") + stat_compare_means(method = "anova", label.y = 400) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "LAC", label.y = 380, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.ps.plot.richness
pdf("./Figures/Mojave Biocrust Fungal Alpha Diversity (Observed) by Crust type.pdf", width = 8, height = 5)
physeq.prune.rarefy.ps.plot.richness
dev.off()
physeq.prune.rarefy.ps.plot.richness = plot_richness(physeq.prune.rarefy, x="Crust_type", color=("Crust_type"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Fungal Alpha Diversity (Chao1) by Crust type") + stat_compare_means(method = "anova", label.y = 400) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "GLC", label.y = 380, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.ps.plot.richness
pdf("./Figures/Mojave Biocrust Fungal Alpha Diversity (Observed) by Crust type.pdf", width = 8, height = 5)
physeq.prune.rarefy.ps.plot.richness
dev.off()
physeq.prune.rarefy.ps.plot.richness.site.layer = plot_richness(physeq.prune.rarefy, x="Site_layer", color=("Site_layer"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Fungal Alpha Diversity (Observed) by Site and Layer") + stat_compare_means(method = "anova", label.y = 400) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "GMT_Sub", label.y = 380, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.ps.plot.richness.site.layer
physeq.prune.rarefy.ps.plot.richness.site.layer = plot_richness(physeq.prune.rarefy, x="Site_layer", color=("Site_layer"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Fungal Alpha Diversity (Observed) by Site and Layer") + stat_compare_means(method = "anova", label.y = 400) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "KELSO_SF", label.y = 380, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.ps.plot.richness.site.layer
physeq.prune.rarefy.ps.plot.richness.site.layer = plot_richness(physeq.prune.rarefy, x="Site_layer", color=("Site_layer"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Fungal Alpha Diversity (Observed) by Site and Layer") + stat_compare_means(method = "anova", label.y = 400) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "GMT_Sub", label.y = 380, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.ps.plot.richness.site.layer
pdf("./Figures/Mojave Biocrust Fungal Alpha Diversity (Observed) by Site and Layer.pdf", width = 8, height = 5)
physeq.prune.rarefy.ps.plot.richness.site.layer
dev.off()
FungiClass = as.character(get_taxa_unique(physeq.prune.rarefy.ps, "Class"))
FungiClass = as.character(get_taxa_unique(physeq.prune.rarefy, "Class"))
FungiClass = FungiClass[complete.cases(FungiClass)]
pdf("./Figures/Fungal Class Alpha Diversity Observed by Site and Layer.pdf", width = 8, height = 5 )
for (i in FungiClass) {
APS = subset_taxa(physeq.prune.rarefy.ps, Class == i)
APS.plot = plot_richness(APS, x="Site_layer", color =("Site_layer"), measures=c("Observed")) + geom_boxplot() + ggtitle(i) + stat_compare_means(method = "anova") + theme(plot.title = element_text(hjust = 0.5))
print(APS.plot)
}
pdf("./Figures/Fungal Class Alpha Diversity Observed by Site and Layer.pdf", width = 8, height = 5 )
for (i in FungiClass) {
APS = subset_taxa(physeq.prune.rarefy, Class == i)
APS.plot = plot_richness(APS, x="Site_layer", color =("Site_layer"), measures=c("Observed")) + geom_boxplot() + ggtitle(i) + stat_compare_means(method = "anova") + theme(plot.title = element_text(hjust = 0.5))
print(APS.plot)
}
dev.off()
pdf("./Figures/Fungal Class Alpha Diversity (Observed) by Crust type.pdf", width = 8, height = 5 )
for (i in FungiClass) {
APS = subset_taxa(physeq.prune.rarefy.ps, Class == i)
APS.plot = plot_richness(APS, x="Crust_type", color =("Crust_type"), measures=c("Observed")) + geom_boxplot() + ggtitle(i) + stat_compare_means(method = "anova") + theme(plot.title = element_text(hjust = 0.5))
print(APS.plot)
}
pdf("./Figures/Fungal Class Alpha Diversity (Observed) by Crust type.pdf", width = 8, height = 5 )
for (i in FungiClass) {
APS = subset_taxa(physeq.prune.rarefy, Class == i)
APS.plot = plot_richness(APS, x="Crust_type", color =("Crust_type"), measures=c("Observed")) + geom_boxplot() + ggtitle(i) + stat_compare_means(method = "anova") + theme(plot.title = element_text(hjust = 0.5))
print(APS.plot)
}
dev.off()
taxa.summary.by.phylum = summarize_taxa(physeq.prune.rarefy, "Phylum")
write.table(taxa.summary.by.phylum, file = "taxa.summary.by.phylum.txt", sep ="\t")
taxcom_sitelayer = ggplot(data = psmelt(physeq.prune.rarefy.ps), mapping = aes_string(x = "Site_layer" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Site and Layer")+
theme(axis.text.x = element_text(angle = 90, hjust = 1))
taxcom_sitelayer = ggplot(data = psmelt(physeq.prune.rarefy), mapping = aes_string(x = "Site_layer" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Site and Layer")+
theme(axis.text.x = element_text(angle = 90, hjust = 1))
#print(taxcom_sitelayer)
pdf("./Figures/Fungal Taxonomic Composition (Class level) by Site and Layer.pdf", width = 12, height = 8 )
taxcom_sitelayer
dev.off()
taxcom_crusttype = ggplot(data = psmelt(physeq.prune.rarefy.ps), mapping = aes_string(x = "Crust_type" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Crust type")+
theme(axis.text.x = element_text(angle = 90, hjust = 1))
taxcom_crusttype = ggplot(data = psmelt(physeq.prune.rarefy), mapping = aes_string(x = "Crust_type" ,y = "Abundance", fill = "Class" )) +
geom_bar(stat="identity", position="fill") +
ggtitle("Fungal Taxonomic Composition (Class level) by Crust type")+
theme(axis.text.x = element_text(angle = 90, hjust = 1))
pdf("./Figures/Fungal Taxonomic Composition (Class level) by Crust type.pdf", width = 12, height = 8 )
taxcom_crusttype
dev.off()
getwd()
setwd("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/BiocrustDiv/Bacteria")
otu = read.table(file="MojaveBacQ2FWLEsilva515806.otu_table.fix.txt", header=T, sep='\t')
head(otu)
dim(otu)
tax <- read.table(file="taxonomy.fix.tsv", sep='\t', header=TRUE)
head(tax)
dim(tax)
tax_filtered <- tax[tax$OTU.ID %in% otu$OTU.ID,]
head(tax_filtered)
dim(tax_filtered)
dim(otu)
tax_filtered = tax_filtered[,c(1,2)]
tax_filtered = separate(tax_filtered, Taxon, c("Kingdom","Phylum","Class","Order", "Family", "Genus","Species"), sep= ";", remove=TRUE)
dim(tax_filtered)
head(tax_filtered)
write.csv(tax_filtered, file="taxonomy_phyloseq_fix.csv")
otus <- read.table("MojaveBacQ2FWLEsilva515806.otu_table.fix.txt",
header=T,sep="\t",row.names = 1)
otumat <- as(as.matrix(otus), "matrix")
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxmat <- read.csv("taxonomy_phyloseq_fix.csv",
sep=",",row.names=1)
row.names(taxmat) = taxmat$OTU.ID
taxmat <- as(as.matrix(taxmat),"matrix")
TAX = tax_table(taxmat)
treefile = "tree.nwk"
tree = read.tree(treefile)
meta = read.table("Mojave_mappingfile_8-Aug-2018.txt",
header=TRUE,row.names=1,
sep="\t",stringsAsFactors=FALSE)
#meta <- meta[which(meta$Layer %in% c("Surface")),]
head(meta)
sampleData <- sample_data(meta)
physeq = phyloseq(OTU,TAX,sampleData,tree)
physeq
physeq.prune = prune_taxa(taxa_sums(physeq) > 5, physeq)
physeq.prune
readcount = data.table(as(sample_data(physeq.prune), "data.frame"),
TotalReads = sample_sums(physeq.prune),
keep.rownames = TRUE)
setnames(readcount, "rn", "SampleID")
#For plotting, use command below.
#SeqDepth = ggplot(readcount, aes(TotalReads)) + geom_histogram() + ggtitle("Sequencing Depth")
readcount = readcount[order(readcount$TotalReads), c("SampleID", "TotalReads")]
head(readcount)
set.seed(711)
physeq.prune.rarefy = rarefy_even_depth(physeq.prune, sample.size = 37435, replace = FALSE, trimOTUs = TRUE)
physeq.prune.rarefy
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy, x="Crust_type", color=("Crust_type"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity (Observed) by Crust type") + stat_compare_means(method = "anova", label.y = 3000) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "LAC", label.y = 2800, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.plot.richness.Crust_type
pdf("./Figures/Mojave Biocrust Bacterial Alpha (Observed) Diversity by Crust type.pdf", width = 8, height = 5 )
physeq.prune.rarefy.plot.richness.Crust_type
dev.off()
physeq.prune.rarefy.plot.richness.Site_layer = plot_richness(physeq.prune.rarefy, x="Site_layer", color=("Site_layer"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity (Observed) by Site and Layer") + stat_compare_means(method = "anova", label.y = 3000) + stat_compare_means(aes(label=..p.signif..), method = "t.test", ref.group = "JTNP_SF", label.y = 2800, hide.ns = TRUE) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
physeq.prune.rarefy.plot.richness.Site_layer
pdf("./Figures/Mojave Biocrust Bacterial Alpha (Observed) Diversity by Site and Layer.pdf", width = 8, height = 5 )
physeq.prune.rarefy.plot.richness.Site_layer
dev.off()
BacPhylum = as.character(get_taxa_unique(physeq.prune.rarefy, "Phylum"))
BacPhylum = BacPhylum[complete.cases(BacPhylum)]
pdf("./Figures/Bacterial Phylum Alpha (Observed) Diversity by Site and Layer.pdf", width = 8, height = 5 )
for (i in BacPhylum) {
APS = subset_taxa(physeq.prune.rarefy, Phylum == i)
APS.plot = plot_richness(APS, x="Site_layer", color =("Site_layer"), measures=c("Observed")) + geom_boxplot() + ggtitle(i) + stat_compare_means(method = "anova") + theme(plot.title = element_text(hjust = 0.5))
print(APS.plot)
}
dev.off()
pdf("./Figures/Bacterial Phylum Alpha (Observed) Diversity by Crust_type .pdf", width = 8, height = 5 )
for (i in BacPhylum) {
APS = subset_taxa(physeq.prune.rarefy, Phylum == i)
APS.plot = plot_richness(APS, x="Crust_type", color =("Crust_type"), measures=c("Observed")) + geom_boxplot() + ggtitle(i) + stat_compare_means(method = "anova") + theme(plot.title = element_text(hjust = 0.5))
print(APS.plot)
}
dev.off()
