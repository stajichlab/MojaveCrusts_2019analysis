xlab("Mean Relative Abundance") +
ylab(Rank) +
theme_bw()
if(!is.null(GroupBy)){
# pRank <- pRank + facet_wrap(facets = as.formula(paste("~", GroupBy)))
pRank <- pRank + geom_point(mapping = aes_string(colour = GroupBy),
size = 5)
} else {
# Don't include error bars for faceted version
pRank <- pRank + geom_errorbarh(aes(xmax = ebarMax,
xmin = ebarMin))
}
return(pRank)
}
otus <- read.table("MojaveBacQ2FWLEsilva515806.otu_table.fix.txt",
header=T,sep="\t",row.names = 1)
otumat <- as(as.matrix(otus), "matrix")
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxmat <- read.csv("taxonomy_phyloseq_fix.csv",
sep=",",row.names=1)
row.names(taxmat) = taxmat$OTU.ID
taxmat <- as(as.matrix(taxmat),"matrix")
TAX = tax_table(taxmat)
treefile = "tree.nwk"
tree = read.tree(treefile)
meta = read.table("Mojave_mappingfile_8-Aug-2018.txt",
header=TRUE,row.names=1,
sep="\t",stringsAsFactors=FALSE)
#meta <- meta[which(meta$Layer %in% c("Surface")),]
head(meta)
sampleData <- sample_data(meta)
physeq = phyloseq(OTU,TAX,sampleData,tree)
physeq
physeq.prune = prune_taxa(taxa_sums(physeq) > 5, physeq)
physeq.prune
readcount = data.table(as(sample_data(physeq.prune), "data.frame"),
TotalReads = sample_sums(physeq.prune),
keep.rownames = TRUE)
setnames(readcount, "rn", "SampleID")
#For plotting, use command below.
#SeqDepth = ggplot(readcount, aes(TotalReads)) + geom_histogram() + ggtitle("Sequencing Depth")
readcount = readcount[order(readcount$TotalReads), c("SampleID", "TotalReads")]
head(readcount)
set.seed(711)
physeq.prune.rarefy = rarefy_even_depth(physeq.prune, sample.size = 37435, replace = FALSE, trimOTUs = TRUE)
physeq.prune.rarefy
alpha.diversity = estimate_richness(physeq.prune.rarefy, measures = c("Observed"))
data.anova = cbind(sample_data(physeq.prune.rarefy), alpha.diversity)
physeq.prune.rarefy.anova = aov(Observed ~ Crust_type, data.anova)
physeq.prune.rarefy.anova.Crusttype_layer = aov(Observed ~ Layer*Crust_type_no_depth, data.anova)
summary(physeq.prune.rarefy.anova)
summary(physeq.prune.rarefy.anova.Crusttype_layer)
alpha.diversity = estimate_richness(physeq.prune.rarefy, measures = c("Observed"))
data.anova = cbind(sample_data(physeq.prune.rarefy), alpha.diversity)
physeq.prune.rarefy.anova = aov(Observed ~ Crust_type, data.anova)
physeq.prune.rarefy.anova.Crusttype_layer = aov(Observed ~ Layer*Crust_type_no_depth, data.anova)
summary(physeq.prune.rarefy.anova)
summary(physeq.prune.rarefy.anova.Crusttype_layer)
physeq.prune.rarefy.anova.CrusttypeLayerInteraction = aov(Observed ~ Layer/Crust_type_no_depth, data.anova)
summary(physeq.prune.rarefy.anova.CrusttypeLayerInteraction)
alpha.diversity = estimate_richness(physeq.prune.rarefy, measures = c("Observed"))
data.anova = cbind(sample_data(physeq.prune.rarefy), alpha.diversity)
physeq.prune.rarefy.anova = aov(Observed ~ Crust_type, data.anova)
physeq.prune.rarefy.anova.Crusttype_layer = aov(Observed ~ Layer*Crust_type_no_depth, data.anova)
summary(physeq.prune.rarefy.anova)
summary(physeq.prune.rarefy.anova.Crusttype_layer)
physeq.prune.rarefy.anova.CrusttypeLayerInteraction = aov(Observed ~ Crust_type_no_depth/Layer, data.anova)
summary(physeq.prune.rarefy.anova.CrusttypeLayerInteraction)
alpha.diversity = estimate_richness(physeq.prune.rarefy, measures = c("Observed"))
data.anova = cbind(sample_data(physeq.prune.rarefy), alpha.diversity)
physeq.prune.rarefy.anova = aov(Observed ~ Crust_type, data.anova)
physeq.prune.rarefy.anova.Crusttype_layer = aov(Observed ~ Layer*Crust_type_no_depth, data.anova)
summary(physeq.prune.rarefy.anova)
summary(physeq.prune.rarefy.anova.Crusttype_layer)
physeq.prune.rarefy.anova.CrusttypeLayerInteraction = aov(Observed ~ Layer/Crust_type_no_depth, data.anova)
summary(physeq.prune.rarefy.anova.CrusttypeLayerInteraction)
physeq.prune.rarefy.plot.richness.Layer = plot_richness(physeq.prune.rarefy, x="Layer", color=("Layer"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Layer") + stat_compare_means(method = "t.test", label.y = 2800) + theme(plot.title = element_text(hjust = 0.5)) + theme_bw()
physeq.prune.rarefy.plot.richness.Layer
alpha.diversity = estimate_richness(physeq.prune.rarefy, measures = c("Observed"))
data.anova = cbind(sample_data(physeq.prune.rarefy), alpha.diversity)
physeq.prune.rarefy.t.test = t.test(Observed ~ Layer, data.anova)
summary(physeq.prune.rarefy.t.test)
alpha.diversity = estimate_richness(physeq.prune.rarefy, measures = c("Observed"))
data.anova = cbind(sample_data(physeq.prune.rarefy), alpha.diversity)
physeq.prune.rarefy.t.test = t.test(Observed ~ Layer, data.anova)
physeq.prune.rarefy.t.test
summary(physeq.prune.rarefy.t.test)
pdf("./Figures/Mojave Biocrust Bacterial Alpha Diversity by Layer.pdf", width = 8, height = 5 )
physeq.prune.rarefy.plot.richness.Layer
dev.off()
pdf("./Figures/Fig2C_Bacterial_Alpha_Div_by_Layer.pdf", width = 8, height = 5 )
physeq.prune.rarefy.plot.richness.Layer
dev.off()
alpha.diversity.SF = estimate_richness(physeq.prune.rarefy.SF, measures = c("Observed"))
physeq.prune.rarefy.SF = subset_samples(physeq.prune.rarefy, Layer=="Surface")
alpha.diversity.SF = estimate_richness(physeq.prune.rarefy.SF, measures = c("Observed"))
data.anova.SF = cbind(sample_data(physeq.prune.rarefy.SF), alpha.diversity.SF)
physeq.prune.rarefy.anova.SF = aov(Observed ~ Site, data.anova.SF)
summary(physeq.prune.rarefy.anova.SF)
tukey.ps = TukeyHSD(x=physeq.prune.rarefy.anova.SF, 'Site', conf.level = 0.95)
generate_label_df <- function(tukey.ps, variable){
# Extract labels and factor levels from Tukey post-hoc
Tukey.levels <- tukey.ps[[variable]][,4]
Tukey.labels <- data.frame(multcompLetters(Tukey.levels)['Letters'])
#I need to put the labels in the same order as in the boxplot :
Tukey.labels$treatment=rownames(Tukey.labels)
Tukey.labels=Tukey.labels[order(Tukey.labels$treatment) , ]
return(Tukey.labels)
}
LABELS=generate_label_df(tukey.ps, 'Site')
names(LABELS) = c('Letters','Site')
LABELS
physeq.prune.rarefy.plot.richness.Site = plot_richness(physeq.prune.rarefy.SF, x="Site", color=("Site"), measures=c("Observed")) + geom_boxplot(lwd=1,fill=c("#999999", "gold2", "cadetblue3", "palegreen2")) + ggtitle("Bacterial Alpha Diversity by Site") + stat_compare_means(method = "anova", label.y = 1222) + theme(plot.title = element_text(hjust = 0.5)) + scale_colour_manual(values = c("#000000", "#E69F00", "#56B4E9", "#009E73")) + geom_text(data=LABELS, aes(x=LABELS$Site, y = 1150, label = LABELS$Letters))
physeq.prune.rarefy.plot.richness.Site
physeq.prune.rarefy.plot.richness.Site = plot_richness(physeq.prune.rarefy.SF, x="Site", color=("Site"), measures=c("Observed")) + geom_boxplot(lwd=1,fill=c("#999999", "gold2", "cadetblue3", "palegreen2")) + ggtitle("Bacterial Alpha Diversity by Site") + stat_compare_means(method = "anova", label.y = 1222) + theme(plot.title = element_text(hjust = 0.5)) + scale_colour_manual(values = c("#000000", "#E69F00", "#56B4E9", "#009E73")) + geom_text(data=LABELS, aes(x=LABELS$Site, y = 1150, label = LABELS$Letters)) + theme_bw()
physeq.prune.rarefy.plot.richness.Site
physeq.prune.rarefy.plot.richness.Site = plot_richness(physeq.prune.rarefy.SF, x="Site", color=("Site"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Site and Layer") + stat_compare_means(method = "anova", label.y = 2800) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Site, y = 1150 , label = LABELS$Letters)) + theme_bw()
physeq.prune.rarefy.plot.richness.Site
ylabel <- data.frame("ylabel" = c(1150,1200,1000,1100))
LABELS$ylabel<-ylabel$ylabel
physeq.prune.rarefy.plot.richness.Site = plot_richness(physeq.prune.rarefy.SF, x="Site", color=("Site"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Site and Layer") + stat_compare_means(method = "anova", label.y = 2800) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Site, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw()
physeq.prune.rarefy.plot.richness.Site
physeq.prune.rarefy.plot.richness.Site = plot_richness(physeq.prune.rarefy.SF, x="Site", color=("Site"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Site and Layer") + stat_compare_means(method = "anova", label.y = 1200) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Site, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw()
physeq.prune.rarefy.plot.richness.Site
physeq.prune.rarefy.plot.richness.Site = plot_richness(physeq.prune.rarefy.SF, x="Site", color=("Site"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Site and Layer") + stat_compare_means(method = "anova", label.y = 1250) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Site, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw()
physeq.prune.rarefy.plot.richness.Site
physeq.prune.rarefy.plot.richness.Site = plot_richness(physeq.prune.rarefy.SF, x="Site", color=("Site"), measures=c("Observed")) + geom_boxplot(lwd=1) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Site and Layer") + stat_compare_means(method = "anova", label.y = 1250) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Site, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw()
physeq.prune.rarefy.plot.richness.Site
physeq.prune.rarefy.plot.richness.Layer = plot_richness(physeq.prune.rarefy, x="Layer", color=("Layer"), measures=c("Observed")) + geom_boxplot(lwd=0.5) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Layer") + stat_compare_means(method = "t.test", label.y = 2800) + theme(plot.title = element_text(hjust = 0.5)) + theme_bw()
physeq.prune.rarefy.plot.richness.Layer
physeq.prune.rarefy.plot.richness.Layer = plot_richness(physeq.prune.rarefy, x="Layer", color=("Layer"), measures=c("Observed")) + geom_boxplot(lwd=0.8) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Layer") + stat_compare_means(method = "t.test", label.y = 2800) + theme(plot.title = element_text(hjust = 0.5)) + theme_bw()
physeq.prune.rarefy.plot.richness.Layer
pdf("./Figures/Fig2D_Bacterial_Alpha_Div_by_Layer.pdf", width = 8, height = 5 )
physeq.prune.rarefy.plot.richness.Layer
dev.off()
physeq.prune.rarefy.plot.richness.Site = plot_richness(physeq.prune.rarefy.SF, x="Site", color=("Site"), measures=c("Observed")) + geom_boxplot(lwd=0.8) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Site and Layer") + stat_compare_means(method = "anova", label.y = 1250) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Site, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw()
physeq.prune.rarefy.plot.richness.Site
ylabel <- data.frame("ylabel" = c(1150,1200,1000,1100))
LABELS$ylabel<-ylabel$ylabel
LABELS
pdf("./Figures/Fig2B_Bacterial_Alpha_Div_by_Site.pdf", width = 8, height = 5 )
physeq.prune.rarefy.plot.richness.Site
dev.off()
physeq.prune.rarefy.plot.richness.Site = plot_richness(physeq.prune.rarefy.SF, x="Site", color=("Site"), measures=c("Observed")) + geom_boxplot(lwd=0.8) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Site") + stat_compare_means(method = "anova", label.y = 1250) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Site, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw()
physeq.prune.rarefy.plot.richness.Site
pdf("./Figures/Fig2B_Bacterial_Alpha_Div_by_Site.pdf", width = 8, height = 5 )
physeq.prune.rarefy.plot.richness.Site
dev.off()
physeq.prune.rarefy.SUB = subset_samples(physeq.prune.rarefy, Layer=="Suburface")
physeq.prune.rarefy.SUB = subset_samples(physeq.prune.rarefy, Layer=="Subsurface")
physeq.prune.rarefy.plot.richness.Site.SUB = plot_richness(physeq.prune.rarefy.SUB, x="Site", color=("Site"), measures=c("Observed")) + geom_boxplot(lwd=0.8) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Site") + stat_compare_means(method = "anova", label.y = 1250) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Site, y = 2200 , label = LABELS$Letters)) + theme_bw()
physeq.prune.rarefy.plot.richness.Site.SUB
alpha.diversity = estimate_richness(physeq.prune.rarefy.SF, measures = c("Observed"))
data.anova = cbind(sample_data(physeq.prune.rarefy.SF), alpha.diversity)
physeq.prune.rarefy.anova.Crusttype = aov(Observed ~ Crust_type, data.anova)
summary(physeq.prune.rarefy.anova.Crusttype)
tukey.ps = TukeyHSD(x=physeq.prune.rarefy.anova, 'Crust_type', conf.level = 0.95)
generate_label_df <- function(tukey.ps, variable){
# Extract labels and factor levels from Tukey post-hoc
Tukey.levels <- tukey.ps[[variable]][,4]
Tukey.labels <- data.frame(multcompLetters(Tukey.levels)['Letters'])
#I need to put the labels in the same order as in the boxplot :
Tukey.labels$treatment=rownames(Tukey.labels)
Tukey.labels=Tukey.labels[order(Tukey.labels$treatment) , ]
return(Tukey.labels)
}
LABELS=generate_label_df(tukey.ps, 'Crust_type')
names(LABELS) = c('Letters','Crust_type')
LABELS
ylabel <- data.frame("ylabel" = c(1150,1050,850,1200,1100))
LABELS$ylabel<-ylabel$ylabel
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy, x="Crust_type", color=("Crust_type"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Crust type and Layer") + stat_compare_means(method = "anova", label.y = 2800) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Crust_type, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw()
physeq.prune.rarefy.plot.richness.Crust_type
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy.SF, x="Crust_type", color=("Crust_type"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Crust type and Layer") + stat_compare_means(method = "anova", label.y = 2800) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Crust_type, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw()
physeq.prune.rarefy.plot.richness.Crust_type
alpha.diversity = estimate_richness(physeq.prune.rarefy.SF, measures = c("Observed"))
data.anova = cbind(sample_data(physeq.prune.rarefy.SF), alpha.diversity)
physeq.prune.rarefy.anova.Crusttype.SF = aov(Observed ~ Crust_type, data.anova)
summary(physeq.prune.rarefy.anova.Crusttype.SF)
tukey.ps = TukeyHSD(x=physeq.prune.rarefy.anova.Crusttype.SF, 'Crust_type', conf.level = 0.95)
generate_label_df <- function(tukey.ps, variable){
# Extract labels and factor levels from Tukey post-hoc
Tukey.levels <- tukey.ps[[variable]][,4]
Tukey.labels <- data.frame(multcompLetters(Tukey.levels)['Letters'])
#I need to put the labels in the same order as in the boxplot :
Tukey.labels$treatment=rownames(Tukey.labels)
Tukey.labels=Tukey.labels[order(Tukey.labels$treatment) , ]
return(Tukey.labels)
}
LABELS=generate_label_df(tukey.ps, 'Crust_type')
names(LABELS) = c('Letters','Crust_type')
LABELS
ylabel <- data.frame("ylabel" = c(1150,1050,850,1200,1100))
LABELS$ylabel<-ylabel$ylabel
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy.SF, x="Crust_type", color=("Crust_type"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Crust type") + stat_compare_means(method = "anova", label.y = 2800) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Crust_type, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw()
physeq.prune.rarefy.plot.richness.Crust_type
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy.SF, x="Crust_type", color=("Crust_type"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Crust type") + stat_compare_means(method = "anova", label.y = 1250) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Crust_type, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw()
physeq.prune.rarefy.plot.richness.Crust_type
ylabel <- data.frame("ylabel" = c(1150,1050,950,1200,1100))
LABELS$ylabel<-ylabel$ylabel
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy.SF, x="Crust_type", color=("Crust_type"), measures=c("Observed")) + geom_boxplot() + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Crust type") + stat_compare_means(method = "anova", label.y = 1250) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Crust_type, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw()
physeq.prune.rarefy.plot.richness.Crust_type
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy.SF, x="Crust_type", color=("Crust_type"), measures=c("Observed")) + geom_boxplot(lwd=0.8) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Crust type") + stat_compare_means(method = "anova", label.y = 1250) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Crust_type, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw()
physeq.prune.rarefy.plot.richness.Crust_type
pdf("./Figures/Fig2F_Bacterial_Alpha_Div_by_Crust_type.pdf", width = 8, height = 5 )
physeq.prune.rarefy.plot.richness.Crust_type
dev.off()
knitr::opts_chunk$set(echo = TRUE)
library(ape)
library(vegan)
library(plyr)
library(dplyr)
library(scales)
library(grid)
library(reshape2)
library(phyloseq)
library(magrittr)
library(ggplot2)
library(ggpubr)
library(data.table)
library(tidyr)
library(tidyverse)
library(multcompView)
library(VennDiagram)
fast_melt = function(physeq){
# supports "naked" otu_table as `physeq` input.
otutab = as(otu_table(physeq), "matrix")
if(!taxa_are_rows(physeq)){otutab <- t(otutab)}
otudt = data.table(otutab, keep.rownames = TRUE)
setnames(otudt, "rn", "taxaID")
# Enforce character taxaID key
otudt[, taxaIDchar := as.character(taxaID)]
otudt[, taxaID := NULL]
setnames(otudt, "taxaIDchar", "taxaID")
# Melt count table
mdt = melt.data.table(otudt,
id.vars = "taxaID",
variable.name = "SampleID",
value.name = "count")
# Remove zeroes, NAs
mdt <- mdt[count > 0][!is.na(count)]
# Calculate relative abundance
mdt[, RelativeAbundance := count / sum(count), by = SampleID]
if(!is.null(tax_table(physeq, errorIfNULL = FALSE))){
# If there is a tax_table, join with it. Otherwise, skip this join.
taxdt = data.table(as(tax_table(physeq, errorIfNULL = TRUE), "matrix"), keep.rownames = TRUE)
setnames(taxdt, "rn", "taxaID")
# Enforce character taxaID key
taxdt[, taxaIDchar := as.character(taxaID)]
taxdt[, taxaID := NULL]
setnames(taxdt, "taxaIDchar", "taxaID")
# Join with tax table
setkey(taxdt, "taxaID")
setkey(mdt, "taxaID")
mdt <- taxdt[mdt]
}
return(mdt)
}
summarize_taxa = function(physeq, Rank, GroupBy = NULL){
Rank <- Rank[1]
if(!Rank %in% rank_names(physeq)){
message("The argument to `Rank` was:\n", Rank,
"\nBut it was not found among taxonomic ranks:\n",
paste0(rank_names(physeq), collapse = ", "), "\n",
"Please check the list shown above and try again.")
}
if(!is.null(GroupBy)){
GroupBy <- GroupBy[1]
if(!GroupBy %in% sample_variables(physeq)){
message("The argument to `GroupBy` was:\n", GroupBy,
"\nBut it was not found among sample variables:\n",
paste0(sample_variables(physeq), collapse = ", "), "\n",
"Please check the list shown above and try again.")
}
}
# Start with fast melt
mdt = fast_melt(physeq)
if(!is.null(GroupBy)){
# Add the variable indicated in `GroupBy`, if provided.
sdt = data.table(SampleID = sample_names(physeq),
var1 = get_variable(physeq, GroupBy))
setnames(sdt, "var1", GroupBy)
# Join
setkey(sdt, SampleID)
setkey(mdt, SampleID)
mdt <- sdt[mdt]
}
# Summarize
Nsamples = nsamples(physeq)
summarydt = mdt[, list(meanRA = sum(RelativeAbundance)/Nsamples,
sdRA = sd(RelativeAbundance),
minRA = min(RelativeAbundance),
maxRA = max(RelativeAbundance)),
by = c(Rank, GroupBy)]
return(summarydt)
}
plot_taxa_summary = function(physeq, Rank, GroupBy = NULL){
# Get taxa summary table
dt1 = summarize_taxa(physeq, Rank = Rank, GroupBy = GroupBy)
# Set factor appropriately for plotting
RankCol = which(colnames(dt1) == Rank)
setorder(dt1, -meanRA)
dt1[, RankFac := factor(dt1[[Rank]],
levels = rev(dt1[[Rank]]))]
dt1[, ebarMax := max(c(0, min(meanRA + sdRA))), by = eval(Rank)]
dt1[, ebarMin := max(c(0, min(meanRA - sdRA))), by = eval(Rank)]
# Set zeroes to one-tenth the smallest value
ebarMinFloor = dt1[(ebarMin > 0), min(ebarMin)]
ebarMinFloor <- ebarMinFloor / 10
dt1[(ebarMin == 0), ebarMin := ebarMinFloor]
pRank = ggplot(dt1, aes(x = meanRA, y = RankFac)) +
scale_x_log10() +
xlab("Mean Relative Abundance") +
ylab(Rank) +
theme_bw()
if(!is.null(GroupBy)){
# pRank <- pRank + facet_wrap(facets = as.formula(paste("~", GroupBy)))
pRank <- pRank + geom_point(mapping = aes_string(colour = GroupBy),
size = 5)
} else {
# Don't include error bars for faceted version
pRank <- pRank + geom_errorbarh(aes(xmax = ebarMax,
xmin = ebarMin))
}
return(pRank)
}
otus <- read.table("MojaveBacQ2FWLEsilva515806.otu_table.fix.txt",
header=T,sep="\t",row.names = 1)
otumat <- as(as.matrix(otus), "matrix")
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxmat <- read.csv("taxonomy_phyloseq_fix.csv",
sep=",",row.names=1)
row.names(taxmat) = taxmat$OTU.ID
taxmat <- as(as.matrix(taxmat),"matrix")
TAX = tax_table(taxmat)
treefile = "tree.nwk"
tree = read.tree(treefile)
meta = read.table("Mojave_mappingfile_8-Aug-2018.txt",
header=TRUE,row.names=1,
sep="\t",stringsAsFactors=FALSE)
#meta <- meta[which(meta$Layer %in% c("Surface")),]
head(meta)
sampleData <- sample_data(meta)
physeq = phyloseq(OTU,TAX,sampleData,tree)
physeq
physeq.prune = prune_taxa(taxa_sums(physeq) > 5, physeq)
physeq.prune
readcount = data.table(as(sample_data(physeq.prune), "data.frame"),
TotalReads = sample_sums(physeq.prune),
keep.rownames = TRUE)
setnames(readcount, "rn", "SampleID")
#For plotting, use command below.
#SeqDepth = ggplot(readcount, aes(TotalReads)) + geom_histogram() + ggtitle("Sequencing Depth")
readcount = readcount[order(readcount$TotalReads), c("SampleID", "TotalReads")]
head(readcount)
set.seed(711)
physeq.prune.rarefy = rarefy_even_depth(physeq.prune, sample.size = 37435, replace = FALSE, trimOTUs = TRUE)
physeq.prune.rarefy
alpha.diversity = estimate_richness(physeq.prune.rarefy, measures = c("Observed"))
data.anova = cbind(sample_data(physeq.prune.rarefy), alpha.diversity)
physeq.prune.rarefy.anova = aov(Observed ~ Crust_type, data.anova)
physeq.prune.rarefy.anova.Crusttype_layer = aov(Observed ~ Layer*Crust_type_no_depth, data.anova)
summary(physeq.prune.rarefy.anova)
summary(physeq.prune.rarefy.anova.Crusttype_layer)
physeq.prune.rarefy.anova.CrusttypeLayerInteraction = aov(Observed ~ Layer/Crust_type_no_depth, data.anova)
summary(physeq.prune.rarefy.anova.CrusttypeLayerInteraction)
physeq.prune.rarefy.anova.Crusttype_layer = aov(Observed ~ Crust_type*Layer, data.anova)
summary(physeq.prune.rarefy.anova.Crusttype_layer)
tukey.ps = TukeyHSD(x=physeq.prune.rarefy.anova, 'Crust_type', conf.level = 0.95)
generate_label_df <- function(tukey.ps, variable){
# Extract labels and factor levels from Tukey post-hoc
Tukey.levels <- tukey.ps[[variable]][,4]
Tukey.labels <- data.frame(multcompLetters(Tukey.levels)['Letters'])
#I need to put the labels in the same order as in the boxplot :
Tukey.labels$treatment=rownames(Tukey.labels)
Tukey.labels=Tukey.labels[order(Tukey.labels$treatment) , ]
return(Tukey.labels)
}
physeq.prune.rarefy.SF = subset_samples(physeq.prune.rarefy, Layer=="Surface")
alpha.diversity.SF = estimate_richness(physeq.prune.rarefy.SF, measures = c("Observed"))
data.anova.SF = cbind(sample_data(physeq.prune.rarefy.SF), alpha.diversity.SF)
physeq.prune.rarefy.anova.SF = aov(Observed ~ Site, data.anova.SF)
summary(physeq.prune.rarefy.anova.SF)
tukey.ps = TukeyHSD(x=physeq.prune.rarefy.anova.SF, 'Site', conf.level = 0.95)
generate_label_df <- function(tukey.ps, variable){
# Extract labels and factor levels from Tukey post-hoc
Tukey.levels <- tukey.ps[[variable]][,4]
Tukey.labels <- data.frame(multcompLetters(Tukey.levels)['Letters'])
#I need to put the labels in the same order as in the boxplot :
Tukey.labels$treatment=rownames(Tukey.labels)
Tukey.labels=Tukey.labels[order(Tukey.labels$treatment) , ]
return(Tukey.labels)
}
LABELS=generate_label_df(tukey.ps, 'Site')
names(LABELS) = c('Letters','Site')
LABELS
ylabel <- data.frame("ylabel" = c(1150,1200,1000,1100))
LABELS$ylabel<-ylabel$ylabel
LABELS
physeq.prune.rarefy.plot.richness.Site = plot_richness(physeq.prune.rarefy.SF, x="Site", color=("Site"), measures=c("Observed")) + geom_boxplot(lwd=0.8) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Site") + stat_compare_means(method = "anova", label.y = 1250) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Site, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw() + scale_colour_brewer(palette="Set1")
physeq.prune.rarefy.plot.richness.Site
pdf("./Figures/Fig2B_Bacterial_Alpha_Div_by_Site.pdf", width = 6, height = 3.8 )
physeq.prune.rarefy.plot.richness.Site
dev.off()
alpha.diversity = estimate_richness(physeq.prune.rarefy, measures = c("Observed"))
data.anova = cbind(sample_data(physeq.prune.rarefy), alpha.diversity)
t.test(Observed ~ Layer, data.anova)
physeq.prune.rarefy.plot.richness.Layer = plot_richness(physeq.prune.rarefy, x="Layer", color=("Layer"), measures=c("Observed")) + geom_boxplot(lwd=0.8) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Layer") + stat_compare_means(method = "t.test", label.y = 2800) + theme(plot.title = element_text(hjust = 0.5)) + theme_bw() + scale_colour_brewer(palette="Set1")
physeq.prune.rarefy.plot.richness.Layer
pdf("./Figures/Fig2D_Bacterial_Alpha_Div_by_Layer.pdf", width = 6, height = 3.8 )
physeq.prune.rarefy.plot.richness.Layer
dev.off()
alpha.diversity = estimate_richness(physeq.prune.rarefy.SF, measures = c("Observed"))
data.anova = cbind(sample_data(physeq.prune.rarefy.SF), alpha.diversity)
physeq.prune.rarefy.anova.Crusttype.SF = aov(Observed ~ Crust_type, data.anova)
summary(physeq.prune.rarefy.anova.Crusttype.SF)
tukey.ps = TukeyHSD(x=physeq.prune.rarefy.anova.Crusttype.SF, 'Crust_type', conf.level = 0.95)
generate_label_df <- function(tukey.ps, variable){
# Extract labels and factor levels from Tukey post-hoc
Tukey.levels <- tukey.ps[[variable]][,4]
Tukey.labels <- data.frame(multcompLetters(Tukey.levels)['Letters'])
#I need to put the labels in the same order as in the boxplot :
Tukey.labels$treatment=rownames(Tukey.labels)
Tukey.labels=Tukey.labels[order(Tukey.labels$treatment) , ]
return(Tukey.labels)
}
LABELS=generate_label_df(tukey.ps, 'Crust_type')
names(LABELS) = c('Letters','Crust_type')
LABELS
LABELS$ylabel<-ylabel$ylabel
LABELS
ylabel <- data.frame("ylabel" = c(1150,1050,950,1200,1100))
LABELS$ylabel<-ylabel$ylabel
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy.SF, x="Crust_type", color=("Crust_type"), measures=c("Observed")) + geom_boxplot(lwd=0.8) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Crust type") + stat_compare_means(method = "anova", label.y = 1250) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Crust_type, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw()
physeq.prune.rarefy.plot.richness.Crust_type
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy.SF, x="Crust_type", color=("Crust_type"), measures=c("Observed")) + geom_boxplot(lwd=0.8) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Crust type") + stat_compare_means(method = "anova", label.y = 1250) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Crust_type, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw() + scale_colour_brewer(palette="Set1")
physeq.prune.rarefy.plot.richness.Crust_type
pdf("./Figures/Fig2F_Bacterial_Alpha_Div_by_Crust_type.pdf", width = 6, height = 3.8 )
physeq.prune.rarefy.plot.richness.Crust_type
dev.off()
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy.SF, x="Crust_type", color=("Crust_type"), measures=c("Observed")) + geom_boxplot(lwd=0.8) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Crust type") + stat_compare_means(method = "anova", label.y = 1250) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Crust_type, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
physeq.prune.rarefy.plot.richness.Crust_type
pdf("./Figures/Fig2F_Bacterial_Alpha_Div_by_Crust_type.pdf", width = 6, height = 3.8 )
physeq.prune.rarefy.plot.richness.Crust_type
dev.off()
physeq.prune.rarefy.plot.richness.Layer = plot_richness(physeq.prune.rarefy, x="Layer", color=("Layer"), measures=c("Observed")) + geom_boxplot(lwd=0.8) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Layer") + stat_compare_means(method = "t.test", label.y = 2800) + theme(plot.title = element_text(hjust = 0.5)) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
physeq.prune.rarefy.plot.richness.Layer
pdf("./Figures/Fig2D_Bacterial_Alpha_Div_by_Layer.pdf", width = 6, height = 3.8 )
physeq.prune.rarefy.plot.richness.Layer
dev.off()
physeq.prune.rarefy.SF = subset_samples(physeq.prune.rarefy, Layer=="Surface")
alpha.diversity.SF = estimate_richness(physeq.prune.rarefy.SF, measures = c("Observed"))
data.anova.SF = cbind(sample_data(physeq.prune.rarefy.SF), alpha.diversity.SF)
physeq.prune.rarefy.anova.SF = aov(Observed ~ Site, data.anova.SF)
summary(physeq.prune.rarefy.anova.SF)
tukey.ps = TukeyHSD(x=physeq.prune.rarefy.anova.SF, 'Site', conf.level = 0.95)
generate_label_df <- function(tukey.ps, variable){
# Extract labels and factor levels from Tukey post-hoc
Tukey.levels <- tukey.ps[[variable]][,4]
Tukey.labels <- data.frame(multcompLetters(Tukey.levels)['Letters'])
#I need to put the labels in the same order as in the boxplot :
Tukey.labels$treatment=rownames(Tukey.labels)
Tukey.labels=Tukey.labels[order(Tukey.labels$treatment) , ]
return(Tukey.labels)
}
LABELS=generate_label_df(tukey.ps, 'Site')
names(LABELS) = c('Letters','Site')
LABELS
ylabel <- data.frame("ylabel" = c(1150,1200,1000,1100))
LABELS$ylabel<-ylabel$ylabel
LABELS
physeq.prune.rarefy.plot.richness.Site = plot_richness(physeq.prune.rarefy.SF, x="Site", color=("Site"), measures=c("Observed")) + geom_boxplot(lwd=0.8) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Site") + stat_compare_means(method = "anova", label.y = 1250) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Site, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw() + scale_colour_brewer(palette="Set1")
physeq.prune.rarefy.plot.richness.Site
physeq.prune.rarefy.plot.richness.Site = plot_richness(physeq.prune.rarefy.SF, x="Site", color=("Site"), measures=c("Observed")) + geom_boxplot(lwd=0.8) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Site") + stat_compare_means(method = "anova", label.y = 1250) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Site, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
physeq.prune.rarefy.plot.richness.Site
pdf("./Figures/Fig2B_Bacterial_Alpha_Div_by_Site.pdf", width = 6, height = 3.8 )
physeq.prune.rarefy.plot.richness.Site
dev.off()
physeq.prune.rarefy.plot.richness.Site = plot_richness(physeq.prune.rarefy.SF, x="Site", color=("Site"), measures=c("Observed")) + geom_boxplot(lwd=0.5) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Site") + stat_compare_means(method = "anova", label.y = 1250) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Site, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
physeq.prune.rarefy.plot.richness.Site
pdf("./Figures/Fig2B_Bacterial_Alpha_Div_by_Site.pdf", width = 6, height = 3.8 )
physeq.prune.rarefy.plot.richness.Site
dev.off()
physeq.prune.rarefy.plot.richness.Layer = plot_richness(physeq.prune.rarefy, x="Layer", color=("Layer"), measures=c("Observed")) + geom_boxplot(lwd=0.5) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Layer") + stat_compare_means(method = "t.test", label.y = 2800) + theme(plot.title = element_text(hjust = 0.5)) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
physeq.prune.rarefy.plot.richness.Layer
pdf("./Figures/Fig2D_Bacterial_Alpha_Div_by_Layer.pdf", width = 6, height = 3.8 )
physeq.prune.rarefy.plot.richness.Layer
dev.off()
alpha.diversity = estimate_richness(physeq.prune.rarefy.SF, measures = c("Observed"))
data.anova = cbind(sample_data(physeq.prune.rarefy.SF), alpha.diversity)
physeq.prune.rarefy.anova.Crusttype.SF = aov(Observed ~ Crust_type, data.anova)
summary(physeq.prune.rarefy.anova.Crusttype.SF)
tukey.ps = TukeyHSD(x=physeq.prune.rarefy.anova.Crusttype.SF, 'Crust_type', conf.level = 0.95)
generate_label_df <- function(tukey.ps, variable){
# Extract labels and factor levels from Tukey post-hoc
Tukey.levels <- tukey.ps[[variable]][,4]
Tukey.labels <- data.frame(multcompLetters(Tukey.levels)['Letters'])
#I need to put the labels in the same order as in the boxplot :
Tukey.labels$treatment=rownames(Tukey.labels)
Tukey.labels=Tukey.labels[order(Tukey.labels$treatment) , ]
return(Tukey.labels)
}
LABELS=generate_label_df(tukey.ps, 'Crust_type')
names(LABELS) = c('Letters','Crust_type')
LABELS
ylabel <- data.frame("ylabel" = c(1150,1050,950,1200,1100))
LABELS$ylabel<-ylabel$ylabel
physeq.prune.rarefy.plot.richness.Crust_type = plot_richness(physeq.prune.rarefy.SF, x="Crust_type", color=("Crust_type"), measures=c("Observed")) + geom_boxplot(lwd=0.5) + ggtitle("Mojave Biocrust Bacterial Alpha Diversity by Crust type") + stat_compare_means(method = "anova", label.y = 1250) + theme(plot.title = element_text(hjust = 0.5)) + geom_text(data=LABELS, aes(x=LABELS$Crust_type, y = LABELS$ylabel , label = LABELS$Letters)) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
physeq.prune.rarefy.plot.richness.Crust_type
pdf("./Figures/Fig2F_Bacterial_Alpha_Div_by_Crust_type.pdf", width = 6, height = 3.8 )
physeq.prune.rarefy.plot.richness.Crust_type
dev.off()
