knitr::opts_chunk$set(echo = TRUE)
library(ape)
library(vegan)
library(plyr)
library(dplyr)
library(scales)
library(grid)
library(reshape2)
library(phyloseq)
library(magrittr)
library(ggplot2)
library(ggpubr)
library(data.table)
library(tidyr)
library(tidyverse)
otu = read.table(file="MojaveBacQ2FWLEsilva515806.otu_table.fix.txt", header=T, sep='\t')
head(otu)
dim(otu)
tax <- read.table(file="taxonomy.fix.tsv", sep='\t', header=TRUE)
head(tax)
dim(tax)
tax_filtered <- tax[tax$OTU.ID %in% otu$OTU.ID,]
head(tax_filtered)
dim(tax_filtered)
dim(otu)
tax_filtered = tax_filtered[,c(1,2)]
tax_filtered = separate(tax_filtered, Taxon, c("Kingdom","Phylum","Class","Order", "Family", "Genus","Species"), sep= ";", remove=TRUE)
dim(tax_filtered)
head(tax_filtered)
write.csv(tax_filtered, file="taxonomy_phyloseq_fix.csv")
otus <- read.table("MojaveBacQ2FWLEsilva515806.otu_table.fix.txt",
header=T,sep="\t",row.names = 1)
otumat <- as(as.matrix(otus), "matrix")
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxmat <- read.csv("taxonomy_phyloseq_fix.csv",
sep=",",row.names=1)
row.names(taxmat) = taxmat$OTU.ID
taxmat <- as(as.matrix(taxmat),"matrix")
TAX = tax_table(taxmat)
treefile = "tree.nwk"
tree = read.tree(treefile)
meta = read.table("Mojave_mappingfile_8-Aug-2018.txt",
header=TRUE,row.names=1,
sep="\t",stringsAsFactors=FALSE)
meta <- meta[which(meta$Layer %in% c("Surface")),]
head(meta)
sampleData <- sample_data(meta)
physeq = phyloseq(OTU,TAX,sampleData,tree)
physeq
physeq.prune = prune_taxa(taxa_sums(physeq) > 5, physeq)
physeq.prune
physeq.prune
readcount = data.table(as(sample_data(physeq.prune), "data.frame"),
TotalReads = sample_sums(physeq.prune),
keep.rownames = TRUE)
setnames(readcount, "rn", "SampleID")
#For plotting, use command below.
#SeqDepth = ggplot(readcount, aes(TotalReads)) + geom_histogram() + ggtitle("Sequencing Depth")
readcount = readcount[order(readcount$TotalReads), c("SampleID", "TotalReads")]
head(readcount)
set.seed(711)
physeq.prune.rarefy = rarefy_even_depth(physeq.prune, sample.size = 37386, replace = FALSE, trimOTUs = TRUE)
physeq.prune.rarefy
physeq.prune.rarefy.merge.sitelayer <- merge_samples(physeq.prune.rarefy, "Site_layer")
sample_data(physeq.prune.rarefy.merge.sitelayer)$Site_layer <- factor(sample_names(physeq.prune.rarefy.merge.sitelayer))
physeq.prune.rarefy.merge.sitelayer
physeq.prune.rarefy.merge.sitelayer.binary = transform_sample_counts(physeq.prune.rarefy.merge.sitelayer, function(abund) 1*(abund>0))
OTU_SF_merge_site = otu_table(physeq.prune.rarefy.merge.sitelayer.binary)
OTU_SF_merge_site = t(OTU_SF_merge_site)
head(OTU_SF_merge_site)
OTU_SF_merge_site_endemic = OTU_SF_merge_site[rowSums(OTU_SF_merge_site == 1) == 1, ]
head(OTU_SF_merge_site_endemic)
OTU_SF_merge_site_endemic = OTU_SF_merge_site[rowSums(OTU_SF_merge_site == 1) >= 1, ]
head(OTU_SF_merge_site_endemic)
OTU_SF_merge_site_endemic = OTU_SF_merge_site[rowSums(OTU_SF_merge_site == 1) == 1, ]
head(OTU_SF_merge_site_endemic)
OTU_SF_merge_site_endemic_df = data.frame(OTUendemic = row.names(OTU_SF_merge_site_endemic))
dim(OTU_SF_merge_site_endemic_df)
otu <- read.table("MojaveBacQ2FWLEsilva515806.otu_table.fix.txt",header=T,sep="\t")
otus.filtered = otu[otu$OTU.ID %in% OTU_SF_merge_site_endemic_df$OTUendemic,]
otus.filtered.rn = otus.filtered[,-1]
rownames(otus.filtered.rn) = otus.filtered[,1]
otumat.endemic <- as(as.matrix(otus.filtered.rn), "matrix")
OTU.endemic = otu_table(otumat.endemic, taxa_are_rows = TRUE)
physeq.endemic = phyloseq(OTU.endemic,TAX,sampleData,tree)
physeq.endemic
physeq.endemic
physeq.endemic.prune = prune_taxa(taxa_sums(physeq.endemic) > 5, physeq)
physeq.endemic.prune = prune_taxa(taxa_sums(physeq.endemic) > 5, physeq)
physeq.endemic.prune = prune_taxa(taxa_sums(physeq.endemic) > 5, physeq.endemic)
physeq.endemic.prune
readcount = data.table(as(sample_data(physeq.endemic.prune), "data.frame"),
TotalReads = sample_sums(physeq.endemic.prune),
keep.rownames = TRUE)
setnames(readcount, "rn", "SampleID")
readcount = readcount[order(readcount$TotalReads), c("SampleID", "TotalReads")]
head(readcount)
set.seed(711)
physeq.endemic.prune.rarefy = rarefy_even_depth(physeq.endemic.prune, sample.size = 1555, replace = FALSE, trimOTUs = TRUE)
physeq.endemic.prune.rarefy
physeq.endemic.prune.rarefy.merge.sitelayer <- merge_samples(physeq.endemic.prune.rarefy, "Site_layer")
sample_data(physeq.endemic.prune.rarefy.merge.sitelayer)$Site_layer <- factor(sample_names(physeq.endemic.prune.rarefy.merge.sitelayer))
physeq.endemic.prune.rarefy.merge.sitelayer
Heatmap.sitelayer.endemic<- prune_taxa(names(sort(taxa_sums(physeq.endemic.prune.rarefy.merge.sitelayer),TRUE)[1:200]), physeq.endemic.prune.rarefy.merge.sitelayer)
Heatmap.sitelayer.endemic.plot = plot_heatmap(Heatmap.sitelayer.endemic, "PCoA", "unifrac", "Site_layer", "Phylum")+ ggtitle("Endemic bacteria heatmap") + theme(plot.title = element_text(hjust = 0.5))
print(Heatmap.sitelayer.endemic.plot)
getwd
getwd()
Heatmap.sitelayer.endemic<- prune_taxa(names(sort(taxa_sums(physeq.endemic.prune.rarefy.merge.sitelayer),TRUE)[1:200]), physeq.endemic.prune.rarefy.merge.sitelayer)
Heatmap.sitelayer.endemic.plot = plot_heatmap(Heatmap.sitelayer.endemic, "PCoA", "unifrac", "Site_layer", "Phylum")+ ggtitle("Bacterial endemic species heatmap") + theme(plot.title = element_text(hjust = 0.5))
print(Heatmap.sitelayer.endemic.plot)
ggsave("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/EndemicSpecies/Bacteria/Figures/Bacterial_endemic_species_heatmap.png", plot = Heatmap.sitelayer.cyano.plot, width = 8, height = 10)
#Heatmap.sitelayer.endemic<- prune_taxa(names(sort(taxa_sums(physeq.endemic.prune.rarefy.merge.sitelayer),TRUE)[1:200]), physeq.endemic.prune.rarefy.merge.sitelayer)
#Heatmap.sitelayer.endemic.plot = plot_heatmap(Heatmap.sitelayer.endemic, "PCoA", "unifrac", "Site_layer", "Phylum")+ ggtitle("Bacterial endemic species heatmap") + theme(plot.title = element_text(hjust = 0.5))
#print(Heatmap.sitelayer.endemic.plot)
ggsave("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/EndemicSpecies/Bacteria/Figures/Bacterial_endemic_species_heatmap.png", plot = Heatmap.sitelayer.endemic.plot, width = 8, height = 10)
#Heatmap.sitelayer.endemic<- prune_taxa(names(sort(taxa_sums(physeq.endemic.prune.rarefy.merge.sitelayer),TRUE)[1:200]), physeq.endemic.prune.rarefy.merge.sitelayer)
#Heatmap.sitelayer.endemic.plot = plot_heatmap(Heatmap.sitelayer.endemic, "PCoA", "unifrac", "Site_layer", "Phylum")+ ggtitle("Bacterial endemic species heatmap") + theme(plot.title = element_text(hjust = 0.5))
#print(Heatmap.sitelayer.endemic.plot)
ggsave("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/EndemicSpecies/Bacteria/Figures/Bacterial_endemic_species_heatmap.png", plot = Heatmap.sitelayer.endemic.plot, width = 8, height = 10)
Heatmap.sitelayer.endemic<- prune_taxa(names(sort(taxa_sums(physeq.endemic.prune.rarefy.merge.sitelayer),TRUE)[1:200]), physeq.endemic.prune.rarefy.merge.sitelayer)
Heatmap.sitelayer.endemic.plot = plot_heatmap(Heatmap.sitelayer.endemic, "PCoA", "unifrac", "Site_layer", "Phylum")+ ggtitle("Bacterial endemic species heatmap (top 100 ASVs)") + theme(plot.title = element_text(hjust = 0.5))
print(Heatmap.sitelayer.endemic.plot)
ggsave("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/EndemicSpecies/Bacteria/Figures/Bacterial_endemic_species_heatmap_top100.png", plot = Heatmap.sitelayer.endemic.plot, width = 8, height = 10)
plot_tree(Heatmap.sitelayer.endemic.cyano, nodelabf=nodeplotboot(), ladderize="left", color="Site_layer", label.tips = "Phylum", text.size = 2) + ggtitle("bacterial endemic species tree") + theme(plot.title = element_text(hjust = 0.5))
plot_tree(Heatmap.sitelayer.endemic, nodelabf=nodeplotboot(), ladderize="left", color="Site_layer", label.tips = "Phylum", text.size = 2) + ggtitle("bacterial endemic species tree") + theme(plot.title = element_text(hjust = 0.5))
Heatmap.sitelayer.endemic<- prune_taxa(names(sort(taxa_sums(physeq.endemic.prune.rarefy.merge.sitelayer),TRUE)[1:100]), physeq.endemic.prune.rarefy.merge.sitelayer)
Heatmap.sitelayer.endemic.plot = plot_heatmap(Heatmap.sitelayer.endemic, "PCoA", "unifrac", "Site_layer", "Phylum")+ ggtitle("Bacterial endemic species heatmap (top 100 ASVs)") + theme(plot.title = element_text(hjust = 0.5))
print(Heatmap.sitelayer.endemic.plot)
ggsave("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/EndemicSpecies/Bacteria/Figures/Bacterial_endemic_species_heatmap_top100.png", plot = Heatmap.sitelayer.endemic.plot, width = 8, height = 10)
plot_tree(Heatmap.sitelayer.endemic, nodelabf=nodeplotboot(), ladderize="left", color="Site_layer", label.tips = "Phylum", text.size = 2) + ggtitle("bacterial endemic species tree") + theme(plot.title = element_text(hjust = 0.5))
pdf("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/EndemicSpecies/Bacteria/Figures/Bacterial_endemic_species_heatmap_top100.pdf" )
plot_tree(Heatmap.sitelayer.endemic, nodelabf=nodeplotboot(), ladderize="left", color="Site_layer", label.tips = "Phylum", text.size = 2) + ggtitle("Bacterial endemic species tree") + theme(plot.title = element_text(hjust = 0.5))
dev.off()
Heatmap.sitelayer.endemic.cyano = subset_taxa(physeq.endemic.prune.rarefy.merge.sitelayer, Phylum == "D_1__Cyanobacteria")
Heatmap.sitelayer.endemic.cyano <- prune_taxa(names(sort(taxa_sums(Heatmap.sitelayer.endemic.cyano),TRUE)[1:100]), Heatmap.sitelayer.endemic.cyano)
Heatmap.sitelayer.endemic.cyano.plot = plot_heatmap(Heatmap.sitelayer.endemic.cyano, "PCoA", "unifrac", "Site_layer", "Family")+ ggtitle("Endemic Cyanobacteria heatmap") + theme(plot.title = element_text(hjust = 0.5))
print(Heatmap.sitelayer.endemic.cyano.plot)
ggsave("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/EndemicSpecies/Bacteria/Figures//Endemic Cyanobacteria Heatmap.png", plot = Heatmap.sitelayer.cyano.plot, width = 8, height = 10)
Heatmap.sitelayer.endemic.cyano = subset_taxa(physeq.endemic.prune.rarefy.merge.sitelayer, Phylum == "D_1__Cyanobacteria")
Heatmap.sitelayer.endemic.cyano <- prune_taxa(names(sort(taxa_sums(Heatmap.sitelayer.endemic.cyano),TRUE)[1:100]), Heatmap.sitelayer.endemic.cyano)
Heatmap.sitelayer.endemic.cyano.plot = plot_heatmap(Heatmap.sitelayer.endemic.cyano, "PCoA", "unifrac", "Site_layer", "Family")+ ggtitle("Endemic Cyanobacteria heatmap") + theme(plot.title = element_text(hjust = 0.5))
print(Heatmap.sitelayer.endemic.cyano.plot)
ggsave("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/EndemicSpecies/Bacteria/Figures//Endemic Cyanobacteria Heatmap.png", plot = Heatmap.sitelayer.endemic.cyano.plot, width = 8, height = 10)
#Mac's preview doesn't work well with heatmap. Still not sure how to fix this but will use png for now.
#pdf("/Volumes/GoogleDrive/My Drive/UCR2018/MacAir2018/Mojave_Project/Mojave_16S_Qiime2/Figures/Bacterial Heatmap by Site and Layer.pdf" )
#Heatmap.sitelayer.cyano.plot
#dev.off()
plot_tree(Heatmap.sitelayer.endemic.cyano, nodelabf=nodeplotboot(), ladderize="left", color="Site_layer", label.tips = "Genus", text.size = 2) + ggtitle("Endemic Cyanobacteria tree") + theme(plot.title = element_text(hjust = 0.5))
pdf("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/EndemicSpecies/Bacteria/Figures/Endemic_Cyano_top100.pdf" )
plot_tree(Heatmap.sitelayer.endemic.cyano, nodelabf=nodeplotboot(), ladderize="left", color="Site_layer", label.tips = "Genus", text.size = 2) + ggtitle("Endemic Cyanobacteria tree") + theme(plot.title = element_text(hjust = 0.5))
dev.off()
pdf("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/EndemicSpecies/Bacteria/Figures/Endemic_Cyano_top100.pdf" )
plot_tree(Heatmap.sitelayer.endemic.cyano, nodelabf=nodeplotboot(), ladderize="left", color="Site_layer", label.tips = "Genus", text.size = 2) + ggtitle("Endemic Cyanobacteria tree (top 100 ASVs") + theme(plot.title = element_text(hjust = 0.5))
dev.off()
pdf("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/EndemicSpecies/Bacteria/Figures/Endemic_Cyano_top100.pdf" )
plot_tree(Heatmap.sitelayer.endemic.cyano, nodelabf=nodeplotboot(), ladderize="left", color="Site_layer", label.tips = "Genus", text.size = 2) + ggtitle("Endemic Cyanobacteria tree (top 100 ASVs") + theme(plot.title = element_text(hjust = 0.5))
dev.off()
pdf("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/EndemicSpecies/Bacteria/Figures/Endemic_Cyano_top100.pdf" )
plot_tree(Heatmap.sitelayer.endemic.cyano, nodelabf=nodeplotboot(), ladderize="left", color="Site_layer", label.tips = "Genus", text.size = 2) + ggtitle("Endemic Cyanobacteria tree (top 100 ASVs)") + theme(plot.title = element_text(hjust = 0.5))
dev.off()
Heatmap.sitelayer.endemic.proteo = subset_taxa(physeq.endemic.prune.rarefy.merge.sitelayer, Phylum == "D_1__Proteobacteria")
Heatmap.sitelayer.endemic.proteo <- prune_taxa(names(sort(taxa_sums(Heatmap.sitelayer.endemic.proteo),TRUE)[1:100]), Heatmap.sitelayer.endemic.proteo)
Heatmap.sitelayer.endemic.proteo.plot = plot_heatmap(Heatmap.sitelayer.endemic.proteo, "PCoA", "unifrac", "Site_layer", "Family")+ ggtitle("Proteobacteria heatmap") + theme(plot.title = element_text(hjust = 0.5))
print(Heatmap.sitelayer.endemic.proteo.plot)
ggsave("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/EndemicSpecies/Bacteria/Figures/Endemic Proteobacteria Heatmap.png", plot = Heatmap.sitelayer.endemic.proteo.plot, width = 8, height = 10)
#Mac's preview doesn't work well with heatmap. Still not sure how to fix this but will use png for now.
#pdf("/Volumes/GoogleDrive/My Drive/UCR2018/MacAir2018/Mojave_Project/Mojave_16S_Qiime2/Figures/Bacterial Heatmap by Site and Layer.pdf" )
#Heatmap.sitelayer.cyano.plot
#dev.off()
plot_tree(Heatmap.sitelayer.endemic.proteo, nodelabf=nodeplotboot(), ladderize="left", color="Site_layer", label.tips = "Genus", text.size = 2) + ggtitle("Endemic Proteobacteria tree") + theme(plot.title = element_text(hjust = 0.5))
plot_tree(Heatmap.sitelayer.endemic.proteo, nodelabf=nodeplotboot(), ladderize="left", color="Site_layer", label.tips = "Genus", text.size = 2) + ggtitle("Endemic Proteobacteria tree") + theme(plot.title = element_text(hjust = 0.5))
pdf("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/EndemicSpecies/Bacteria/Figures/Endemic_Cyano_top100.pdf" )
plot_tree(Heatmap.sitelayer.endemic.proteo, nodelabf=nodeplotboot(), ladderize="left", color="Site_layer", label.tips = "Genus", text.size = 2) + ggtitle("Endemic Proteobacteria tree (top 100 ASVs)") + theme(plot.title = element_text(hjust = 0.5))
dev.off()
pdf("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/EndemicSpecies/Bacteria/Figures/Endemic_Proteo_top100.pdf" )
plot_tree(Heatmap.sitelayer.endemic.proteo, nodelabf=nodeplotboot(), ladderize="left", color="Site_layer", label.tips = "Genus", text.size = 2) + ggtitle("Endemic Proteobacteria tree (top 100 ASVs)") + theme(plot.title = element_text(hjust = 0.5))
dev.off()
pdf("/Volumes/GoogleDrive/My Drive/UCR2019/Mojave_project2019/MojaveCrusts_2019analysis/EndemicSpecies/Bacteria/Figures/Endemic_Cyano_top100.pdf" )
plot_tree(Heatmap.sitelayer.endemic.cyano, nodelabf=nodeplotboot(), ladderize="left", color="Site_layer", label.tips = "Genus", text.size = 2) + ggtitle("Endemic Cyanobacteria tree (top 100 ASVs)") + theme(plot.title = element_text(hjust = 0.5))
dev.off()
